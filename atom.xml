<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>冷月无声</title>
  
  <subtitle>相信积累的力量！</subtitle>
  <link href="https://www.lengyuewusheng.com/atom.xml" rel="self"/>
  
  <link href="https://www.lengyuewusheng.com/"/>
  <updated>2022-03-25T03:12:45.388Z</updated>
  <id>https://www.lengyuewusheng.com/</id>
  
  <author>
    <name>冷月无声</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Docker镜像定制实践</title>
    <link href="https://www.lengyuewusheng.com/docker%E9%95%9C%E5%83%8F%E5%AE%9A%E5%88%B6%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://www.lengyuewusheng.com/docker%E9%95%9C%E5%83%8F%E5%AE%9A%E5%88%B6%E5%AE%9E%E8%B7%B5.html</id>
    <published>2022-03-20T09:39:08.000Z</published>
    <updated>2022-03-25T03:12:45.388Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>本文简单总结了过去两年对容器化的一些经验和浅显思考，抛砖引玉，分享给大家。欢迎有相关思路或实践的同学沟通探讨。</p></blockquote><span id="more"></span><h1 id="镜像定制的方法论"><a href="#镜像定制的方法论" class="headerlink" title="镜像定制的方法论"></a>镜像定制的方法论</h1><h2 id="Red-Hat的云原生容器设计原则"><a href="#Red-Hat的云原生容器设计原则" class="headerlink" title="Red Hat的云原生容器设计原则"></a>Red Hat的云原生容器设计原则</h2><ul><li><p>唯一关注性原则(Single concern principle · SCP)<br>SCP类似于<a href="https://zh.wikipedia.org/wiki/SOLID_(%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1)">SOLID</a>的单一职责原则(SRP)，容器通常管理单个进程，并且大多数时候是通过该进程解决一个问题。如果容器化微服务需要解决多个关注点，则可以使用sidecar或init-containers等模式将多个容器组合成一个部署单元(Pod)，其中每个容器仍然处理一个关注点。</p></li><li><p>高度可观测性原则(High observability principle · HOP)<br>容器提供了一种统一的方式来打包和运行应用程序。任何旨在成为云原生公民的容器都必须为运行时环境提供API，以观察容器的健康状况并触发相应行为。这是以统一方式自动化容器更新和生命周期的基本前提，同时也提高了系统的弹性和用户体验。实际上，容器化应用程序至少应提供存活和就绪状态检查的API。应用程序应将重要事件记录到标准错误(STDERR)和标准输出(STDOUT)中，以便通过Fluentd或Logstash等工具进行日志聚合，并可与OpenTracing、Prometheus等工具集成。</p></li><li><p>生命周期一致性原则(Life-cycle conformance principle · LCP)<br>应用程序可以读取来自管理平台的事件，并作出响应。来自管理平台的各种事件旨在管理容器的生命周期，应用程序将决定要处理哪些事件。</p></li><li><p>镜像不可变更性原则（Image immutability principle · IIP）<br>容器化应用程序是不可变的，不会在不同环境之间发生变化。使用外部方法来存储运行时数据，通过外部化配置区分不同环境，而非为每个环境创建或修改容器。容器化应用程序中的任何更改都应构建新的容器镜像并在所有环境中重新应用。</p></li><li><p>进程可处置性原则（Process disposability principle · PDP）<br>容器化应用程序必须保持其无状态、分布式和冗余。能够快速启动和关闭。</p></li><li><p>自包含性原则(Self-containment principle · S-CP)<br>容器应该包含它在构建时所需的一切。</p></li><li><p>运行时约束性原则(Runtime confinement principle·RCP)<br>容器应声明其资源需求并将该信息传递给管理平台，应用程序应保持在指定的资源需求范围内运行。</p></li></ul><h2 id="部分最佳实践"><a href="#部分最佳实践" class="headerlink" title="部分最佳实践"></a>部分最佳实践</h2><ul><li><p>精简镜像。尽可能小的容器镜像可以减少构建和网络传输时间。</p></li><li><p>支持任意用户ID。避免使用sudo命令或要求特定用户ID来运行容器。</p></li><li><p>声明重要端口。使用EXPOSE命令声明端口，将更易读和易维护。</p></li><li><p>持久化卷。需要在容器销毁后依然保留的数据存储在持久化卷中。</p></li><li><p>声明元数据。标签和注释等元数据可以使容器镜像更易用和易维护。</p></li><li><p>宿主和镜像间同步。宿主属性同步到容器，如时间和机器id等。</p></li><li><p>使用.dockerignore 文件。</p></li><li><p>多阶段构建，压缩镜像大小。</p></li><li><p>利用构建缓存，加速构建。</p></li></ul><h1 id="base镜像的定制"><a href="#base镜像的定制" class="headerlink" title="base镜像的定制"></a>base镜像的定制</h1><h2 id="base镜像选型"><a href="#base镜像选型" class="headerlink" title="base镜像选型"></a>base镜像选型</h2><table><thead><tr><th align="left">系统名称</th><th align="left">状态</th></tr></thead><tbody><tr><td align="left"><a href="https://busybox.net/">BusyBox</a></td><td align="left">非常轻量，Multi-Call binary</td></tr><tr><td align="left"><a href="https://alpinelinux.org/">Alpine</a></td><td align="left">轻量、基于musl和BusyBox，包含包管理器</td></tr><tr><td align="left"><a href="https://github.com/GoogleContainerTools/distroless">distroless</a></td><td align="left">及其轻量，不包含包管理器、shell</td></tr><tr><td align="left"><a href="https://github.com/vmware/photon">Photon Platform（VMware光子操作系统）</a></td><td align="left">针对vSphere和云计算平台</td></tr><tr><td align="left"><a href="https://github.com/rancher/os">RacncherOS</a></td><td align="left">不再维护</td></tr><tr><td align="left"><a href="https://coreos.com/">CoreOS</a></td><td align="left">不再维护</td></tr><tr><td align="left"><a href="https://www.projectatomic.io/">Atomic（红帽原子项目）</a></td><td align="left">不再维护</td></tr></tbody></table><ul><li>在轻量和易用性之间取折中，综合考虑社区活跃度，生态丰富度等多方面因素，选定<code>Alpine</code>作为base镜像进行定制。当然这不代表其它系统镜像有任何缺陷，适合的就是最好的，也可以选用其它类型的系统镜像。</li></ul><h2 id="定制优化"><a href="#定制优化" class="headerlink" title="定制优化"></a>定制优化</h2><ul><li><p>追加必要的软件包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca-certificates tzdata sysstat procps lsof strace tcpdump paris-traceroute-ping vim bash rsync curl iproute2 alpine-base coreutils bind-tools tini shadow logrotate</span><br></pre></td></tr></table></figure><ul><li>易用性和镜像大小之间取平衡。</li></ul></li><li><p>优化vim，定制vim配置，不建议安装扩展。</p></li><li><p>声明时区。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -v /usr/share/zoneinfo/Asia/Shanghai /etc/localtime;</span><br><span class="line">echo &quot;Asia/Shanghai&quot; &gt;  /etc/timezone;</span><br></pre></td></tr></table></figure></li><li><p>定制登录用户相关的环境变量。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># alias</span><br><span class="line">echo &quot;alias ll=&#x27;ls -l --color=auto&#x27;&quot; &gt;&gt; /etc/profile.d/alias.sh;</span><br><span class="line">echo &quot;alias tailf=&#x27;tail -f&#x27;&quot; &gt;&gt; /etc/profile.d/alias.sh;</span><br><span class="line"># history</span><br><span class="line">echo &quot;HISTSIZE=3000&quot; &gt;&gt; /etc/profile.d/tty_rc.sh;</span><br><span class="line">echo &quot;HISTFILESIZE=3000&quot; &gt;&gt; /etc/profile.d/tty_rc.sh;</span><br><span class="line">echo &#x27;HISTTIMEFORMAT=&quot;%Y-%m-%d %T  &quot;&#x27; &gt;&gt; /etc/profile.d/tty_rc.sh;</span><br><span class="line">echo -e &quot;# .bashrc\nsource /etc/profile&quot; &gt;&gt; $&#123;HOME&#125;/.bashrc;</span><br><span class="line"># tty</span><br><span class="line">echo &#x27;PS1=&quot;[\u@\H:\w]\$ &quot;&#x27; &gt;&gt; /etc/profile.d/tty_rc.sh;</span><br><span class="line"># bash</span><br><span class="line">sed -i &#x27;s/\/bin\/ash$/\/bin\/bash/g&#x27; /etc/passwd;</span><br><span class="line">unlink /bin/sh;</span><br><span class="line">ln -svf /bin/bash /bin/sh;</span><br></pre></td></tr></table></figure></li><li><p>使用<code>tini</code>管理进程。</p><ul><li>避免僵尸进程的产生；</li><li>处理Docker进程信号；</li><li>对于镜像完全透明。</li></ul></li></ul><h1 id="是否需要进一步对镜像瘦身"><a href="#是否需要进一步对镜像瘦身" class="headerlink" title="是否需要进一步对镜像瘦身"></a>是否需要进一步对镜像瘦身</h1><p>最佳实践中提到了一条精简镜像，那么我们是否需要使用工具如<a href="https://github.com/docker-slim/docker-slim">docker-slim</a>，对基础镜像甚至后面提到的应用镜像进行瘦身呢？在<a href="https://weread.qq.com/web/reader/eea327d072702b74eea9ad7">《Google系统架构解密》</a>一书中提到了零接触生产(Zero Touch Production, ZTP)的概念。理论上我们确实不应人工接触生产环境。这是规范化和运维自动化的终极目标。ZTP可以显著降低故障率和安全风险。但是这对我们的代码质量、架构设计以及自动化能力提出了很高的要求。</p><p>结合实际，如果当前阶段我们达到了ZTP的要求，是可以对镜像进一步瘦身的，因为越精简越轻量意味着越安全、风险越小。但是如果尚未达到完全的ZTP阶段，经过实际的测试体验，删减后的镜像接近裸进程，是没有易用性可言的。本文成立的前提显然是在当前阶段尚未达到完全ZTP水平的场景。另外在开发、测试等非生产的容器环境场景，我们也会更多考虑易用性的问题。</p><h1 id="golang应用镜像的定制"><a href="#golang应用镜像的定制" class="headerlink" title="golang应用镜像的定制"></a>golang应用镜像的定制</h1><ul><li><p>golang应用的编译构建和镜像打包阶段在Docker环境中执行，用完即删，以保证持续纯净的构建环境。</p></li><li><p>将golang的缓存目录挂载到构建机的宿主目录下，复用缓存。</p></li></ul><p>基于以上两点，考虑如何针对应用的构建环境以及运行时环境镜像进行拆分设计。</p><h2 id="golang应用构建环境镜像定制"><a href="#golang应用构建环境镜像定制" class="headerlink" title="golang应用构建环境镜像定制"></a>golang应用构建环境镜像定制</h2><ul><li><p>golang的构建环境变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ENV GOPATH /go</span><br><span class="line">ENV PATH $GOPATH/bin:$PATH</span><br><span class="line">mkdir -pv $GOPATH/&#123;bin,pkg,src&#125;;</span><br><span class="line">go env -w GOPROXY=&quot;https://goproxy.cn,https://goproxy.io,direct&quot;;</span><br><span class="line">go env -w CGO_ENABLED=0;</span><br><span class="line">go env -w GOFLAGS=&quot;-mod=readonly&quot;;</span><br><span class="line">go env -w GOOS=&quot;linux&quot;;</span><br><span class="line">go env -w GOARCH=&quot;amd64&quot;;</span><br><span class="line">WORKDIR $GOPATH/src</span><br></pre></td></tr></table></figure><ul><li>也可以集成安全扫描、语法扫描等扫描工具。</li></ul></li><li><p>构建步骤的关键逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GIT_VERSION=$(git describe --tags --always --dirty=&quot;-dev&quot;)</span><br><span class="line">GIT_COMMIT=$(git rev-parse HEAD)</span><br><span class="line">BUILD_DATE=$(date &quot;+%Y-%m-%d_%H%M%S&quot;)</span><br><span class="line">APP_VERSION=&quot;$&#123;BUILD_DATE&#125;_$&#123;GIT_VERSION&#125;&quot;</span><br><span class="line"></span><br><span class="line">go mod download</span><br><span class="line"></span><br><span class="line">go build -ldflags &quot;-s -w -X main.version=$&#123;APP_VERSION&#125; -X main.commit=$&#123;GIT_COMMIT&#125;&quot; -o $GOPATH/bin/$&#123;APP_NAME:-app&#125;  main.go</span><br></pre></td></tr></table></figure></li></ul><h2 id="golang应用运行时环境镜像定制"><a href="#golang应用运行时环境镜像定制" class="headerlink" title="golang应用运行时环境镜像定制"></a>golang应用运行时环境镜像定制</h2><ul><li>golang应用环境可在base镜像的基础上，集成logrotate。并规范应用的目录规划和启动方式。</li></ul><h1 id="php应用镜像的定制"><a href="#php应用镜像的定制" class="headerlink" title="php应用镜像的定制"></a>php应用镜像的定制</h1><h2 id="php扩展如何管理"><a href="#php扩展如何管理" class="headerlink" title="php扩展如何管理"></a>php扩展如何管理</h2><p><a href="https://github.com/docker-library/php">docker社区</a>提供的方案是通过源码编译，结合多个脚本组合管理，实现较为复杂。个人推荐的方案是通过apk全量将扩展集成到镜像中，然后通过php的扩展配置文件，管理哪些扩展生效。此种方法虽然会导致镜像存在冗余数据，但是易用性更强。</p><h2 id="php和nginx环境是否应该集成"><a href="#php和nginx环境是否应该集成" class="headerlink" title="php和nginx环境是否应该集成"></a>php和nginx环境是否应该集成</h2><p>一般php应用和nginx代理搭配使用。按照唯一关注性原则(SCP)，理论上应该拆分成两个container组成一个Pod的方式拆分。但是这种拆分的问题非常明显：</p><ul><li>nginx和php需要共享代码目录；</li><li>nginx和php需要分别滚动日志文件；</li><li>nginx和php分别分别声明容器资源，降低资源利用率和灵活度；</li><li>logrotate需给容器内进程发送信号，分别自带logrotate又会造成冗余。</li></ul><p>本质上只有php环境的镜像中，只能提供fast_cgi服务，不是一个完整的http服务。只有集成了代理之后，才能提供完整的功能。一定程度上也符合唯一关注性原则。参考相关应用社区提供的php环境镜像一般也都是php-fpm和代理集成的实现方式。</p><h2 id="如何避免php-fpm进程退出带来的风险"><a href="#如何避免php-fpm进程退出带来的风险" class="headerlink" title="如何避免php-fpm进程退出带来的风险"></a>如何避免php-fpm进程退出带来的风险</h2><p>nginx和php-fpm共存于一个镜像中，php-fpm作为后台进程。一旦php-fpm进程异常，可能会导致业务请求返回502。可以通过开启php-fpm的ping检测功能，nginx层代理的ping.path作为Pod的存活检测接口，这样可以实现，php-fpm异常时，容器自动销毁重建。</p><h1 id="lua应用镜像定制"><a href="#lua应用镜像定制" class="headerlink" title="lua应用镜像定制"></a>lua应用镜像定制</h1><ul><li>在<a href="http://openresty.org/package/alpine/">alpine官方</a>提供的openresty的apk包的基础上，定制默认配置，如日志格式、代码目录、lua配置等；</li><li>集成logrotate配置，容器内建议滚动保留少量本地日志，便于出现异常时快速定位原因。</li></ul><h1 id="使用init-Container将运行时环境和代码剥离"><a href="#使用init-Container将运行时环境和代码剥离" class="headerlink" title="使用init Container将运行时环境和代码剥离"></a>使用init Container将运行时环境和代码剥离</h1><ul><li>避免由于镜像管理不善，增加敏感信息泄露的风险；</li><li>通过Secret对象传入代码库或制品库token，形成鉴权闭环；</li><li>允许开发者在初始化容器阶段执行一些预处理操作，如创建缓存目录；</li><li>此种方式一定程度减小harbor的存储压力。</li></ul><p>以php应用为例,init Container镜像中的entrypoint.sh脚本中的部分关键逻辑如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"># 下载代码</span><br><span class="line">git clone --depth 1 -b $&#123;gitTag&#125; https://$&#123;gitUser&#125;:$&#123;gitToken&#125;@$&#123;gitRepo&#125;</span><br><span class="line">if [ $? -ne 0 ]; then</span><br><span class="line">  git clone https://$&#123;gitUser&#125;:$&#123;gitToken&#125;@$&#123;gitRepo&#125;</span><br><span class="line">  git checkout $&#123;gitTag&#125;</span><br><span class="line">fi</span><br><span class="line">unset gitUser</span><br><span class="line">unset gitToken</span><br><span class="line">......</span><br><span class="line"># 根据配置文件管理php扩展，ph扩展的配置文件作为业务代码的一部分，由版本化工具管理。</span><br><span class="line">if [ -s &quot;$&#123;phpExtConf:-zruntime/modules.ini&#125;&quot; ]; then</span><br><span class="line">  [ -d /etc/php7/conf.d ] &amp;&amp; rsync -avP $&#123;phpExtConf:-zruntime/modules.ini&#125; /etc/php7/conf.d/ || true</span><br><span class="line">  [ -d /etc/php5/conf.d ] &amp;&amp; rsync -avP $&#123;phpExtConf:-zruntime/modules.ini&#125; /etc/php5/conf.d/ || true</span><br><span class="line">  # 由于init container退出后才开始启动应用容器，因此此处不需要kill -USR2</span><br><span class="line">  # kill -USR2 $(cat /run/php-fpm.pid)</span><br><span class="line">fi</span><br><span class="line">......</span><br><span class="line"># 允许用户在准备代码阶段执行简单的脚本逻辑，由于此处的脚本是从代码库中拉取，因此风险相对可控。</span><br><span class="line">if [ -s &quot;$&#123;initScript&#125;&quot; ]; then</span><br><span class="line">  cat &quot;$&#123;initScript&#125;&quot; |sed -e &#x27;s/rm /echo /g&#x27; -e &#x27;s/find /echo /g&#x27; -e &#x27;s/dirname /echo /g&#x27; -e &#x27;s/cd /echo /g&#x27; -e &#x27;s/ \// /g&#x27; -e &#x27;s/ \\\// /g&#x27;|/bin/sh</span><br><span class="line">fi</span><br><span class="line">......</span><br><span class="line"># 允许用户通过文件方式主动声明在生产环境中需要显式删除的文件或目录，如测试配置文件、文档文件等。</span><br><span class="line">if [ -s &quot;$&#123;deleteList&#125;&quot; ]; then</span><br><span class="line">  cat &quot;$&#123;deleteList&#125;&quot; |sed &#x27;s/\(\.*\/\+\)\+$//g&#x27; |xargs -ti rm -rvf &#123;&#125;</span><br><span class="line">fi</span><br><span class="line">......</span><br><span class="line"># 集成固定逻辑清理一些固定的明确无需保留的文件。</span><br><span class="line">rm -rvf .git .drone.yml .gitlab-ci.yml .gitignore .dockerignore Makefile README.md values.yaml zruntime zlist.del zinit.sh /root/entrypoint.sh || true</span><br><span class="line">......</span><br></pre></td></tr></table></figure><ul><li>当然，任何方案都不是无懈可击的，此种实现方案的一个明显缺陷在于，每一个Pod副本都需要下载一遍文件，Pod重建时也存在这个问题。但这种内网传输成本我们认为是可以接受的。</li></ul><h1 id="crond定时任务如何考虑"><a href="#crond定时任务如何考虑" class="headerlink" title="crond定时任务如何考虑"></a>crond定时任务如何考虑</h1><p>crond在容器中主要为logrotate服务，在微服务架构下，crond应以Sidecar模式的CronJob工作负载形式存在。但具体到logrotate日志滚动实现，crond和logrotate集成在应用镜像中更易用更易实现。可以考虑的实现方式是，将crond和logrotate集成到base镜像中，在应用镜像中按需增加logrotate配置，并启动crond进程。<br><a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/">Kubernetes官方</a>建议使用日志代理，在实际生产中，把握原则灵活实现即可。</p><h1 id="容器应用中是否应该集成logrotate"><a href="#容器应用中是否应该集成logrotate" class="headerlink" title="容器应用中是否应该集成logrotate"></a>容器应用中是否应该集成logrotate</h1><p>问题的关键在于日志在容器内是否考虑落地，如果直接被日志代理转发则不用集成。否则必须考虑日志文件的持续滚动，避免文件累积。实际情况中，我们还很难做到完全不需要登录到容器内排查问题，如果基于此考虑的话，在本地落地一份日志副本无疑是最便于排查问题的方式。当然我们依然可以同时启动日志代理，将另一路日志副本收集并进行相应的加工处理。</p><h1 id="参阅资料"><a href="#参阅资料" class="headerlink" title="参阅资料"></a>参阅资料</h1><ul><li><p><a href="https://www.12factor.net/zh_cn/">软件交付的12要素</a></p></li><li><p><a href="https://github.com/opencontainers/runtime-spec">runtime-spec</a></p></li><li><p><a href="https://www.redhat.com/en/resources/cloud-native-container-design-whitepaper">RedHat·容器应用的设计原则</a></p></li><li><p><a href="https://zh.wikipedia.org/wiki/SOLID_(%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1">面向对象设计的五个基本原则·SOLID</a></p></li><li><p><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Dockerfile最佳实践</a></p></li><li><p><a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/docker/init/docker_tini.html">Docker tini进程管理器</a></p></li><li><p><a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/">kubernetes日志架构</a></p></li><li><p><a href="https://kubernetes.io/zh/blog/2018/03/principles-of-container-app-design/">基于容器的应用程序设计原理</a></p></li><li><p><a href="https://www.redhat.com/zh/topics/containers/kubernetes-architecture">RedHat·Kubernetes 架构简介</a></p></li><li><p><a href="https://kuboard.cn/learning/k8s-practice/micro-service/design-pattern.html#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99">kuboard.cn·容器应用的设计原则、模式和反模式</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;本文简单总结了过去两年对容器化的一些经验和浅显思考，抛砖引玉，分享给大家。欢迎有相关思路或实践的同学沟通探讨。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Docker" scheme="https://www.lengyuewusheng.com/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://www.lengyuewusheng.com/tags/Docker/"/>
    
    <category term="容器化" scheme="https://www.lengyuewusheng.com/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>力荐几款开发者必备的Chrome插件</title>
    <link href="https://www.lengyuewusheng.com/%E5%8A%9B%E8%8D%90%E5%87%A0%E6%AC%BE%E5%BC%80%E5%8F%91%E8%80%85%E5%BF%85%E5%A4%87%E7%9A%84chrome%E6%8F%92%E4%BB%B6.html"/>
    <id>https://www.lengyuewusheng.com/%E5%8A%9B%E8%8D%90%E5%87%A0%E6%AC%BE%E5%BC%80%E5%8F%91%E8%80%85%E5%BF%85%E5%A4%87%E7%9A%84chrome%E6%8F%92%E4%BB%B6.html</id>
    <published>2022-02-26T08:47:23.000Z</published>
    <updated>2022-03-24T12:51:03.436Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>工欲善其事，必先利其器。重度工具控力荐几款小众而实用的Chrome插件。</p></blockquote><span id="more"></span><h1 id="copytables"><a href="#copytables" class="headerlink" title="copytables"></a><a href="https://github.com/gebrkn/copytables">copytables</a></h1><h2 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>copytables是开源的用于选择和复制html页面上的表格单元格的Chrome扩展。</p><h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><p>快速选取复制如CMDB、confluence中的表格单元格信息。</p><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ul><li>按住Alt(Mac: option)并用鼠标拖动选择单元格；</li><li>按住Alt+Ctrl(Mac: option+command)并拖动以选择列；</li><li>选择完成后，<code>Ctrl+C(Mac: command+C)</code>完成复制操作。<br><img data-src="https://lengyuewusheng.com/assets/images/chrome-extensions/copytables.png" alt="copytables"></li></ul><h2 id="安装地址"><a href="#安装地址" class="headerlink" title="安装地址"></a>安装地址</h2><p><a href="https://chrome.google.com/webstore/detail/copytables/ekdpkppgmlalfkphpibadldikjimijon?hl=zh-CN">chrome 网上应用店·copytables</a></p><h1 id="User-Agent-Switcher"><a href="#User-Agent-Switcher" class="headerlink" title="User-Agent Switcher"></a>User-Agent Switcher</h1><h2 id="插件介绍-1"><a href="#插件介绍-1" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>该插件提供了一个工具栏按钮，可以使用该按钮在不同的User-Agent关键字之间切换，或者输入自定义的ua关键字。<br>相比<a href="https://chrome.google.com/webstore/detail/user-agent-switcher-for-c/djflhoibgkdhkhhcedjiklpkjnoahfmg?hl=zh-CN">User-Agent Switcher for Chrome</a>，虽然其用户规模更大，但是由于<code>User-Agent Switcher</code>在交互上的便捷性，个人依然推荐前者。</p><h2 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>验证站点是否存在基于User-Agent的访问限制策略；</li><li>验证站点基于User-Agent的跳转或显示逻辑是否生效。</li></ul><h2 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h2><p>直接在扩展程序清单中调出插件并选择或自定义ua类型即可。<br><img data-src="https://lengyuewusheng.com/assets/images/chrome-extensions/User-AgentSwitcher.png" alt="User-AgentSwitcher"></p><h2 id="安装地址-1"><a href="#安装地址-1" class="headerlink" title="安装地址"></a>安装地址</h2><p><a href="https://chrome.google.com/webstore/detail/user-agent-switcher/lkmofgnohbedopheiphabfhfjgkhfcgf?hl=zh-CN">chrome 网上应用店·User-Agent Switcher</a></p><h1 id="Website-IP"><a href="#Website-IP" class="headerlink" title="Website IP"></a>Website IP</h1><h2 id="插件介绍-2"><a href="#插件介绍-2" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>一个将当前站点解析并访问的的IP信息显示在网站右下角的简单却实用的插件。当然你如果不嫌麻烦也可以通过浏览器的调试功能查看站点IP。</p><h2 id="适用场景-2"><a href="#适用场景-2" class="headerlink" title="适用场景"></a>适用场景</h2><p>确认站点是否被劫持，确认绑定hosts调试访问是否生效等场景。</p><h2 id="使用方法-2"><a href="#使用方法-2" class="headerlink" title="使用方法"></a>使用方法</h2><p>插件开启状态下，在非隐身模式下访问页面，在页面右下角可以看到站点IP信息。<br><img data-src="https://lengyuewusheng.com/assets/images/chrome-extensions/WebsiteIP.png" alt="WebsiteIP"></p><h2 id="安装地址-2"><a href="#安装地址-2" class="headerlink" title="安装地址"></a>安装地址</h2><p><a href="https://chrome.google.com/webstore/detail/website-ip/ghbmhlgniedlklkpimlibbaoomlpacmk?hl=zh-CN">chrome 网上应用店·Website IP</a></p><h1 id="Set-Character-Encoding"><a href="#Set-Character-Encoding" class="headerlink" title="Set Character Encoding"></a>Set Character Encoding</h1><h2 id="插件介绍-3"><a href="#插件介绍-3" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>支持手动设置浏览器页面的字符集编码。</p><h2 id="适用场景-3"><a href="#适用场景-3" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>调试页面的乱码问题。</li></ul><h2 id="使用方法-3"><a href="#使用方法-3" class="headerlink" title="使用方法"></a>使用方法</h2><p>右键单击网页上的某处以手动设置字符编码。所选字符集将自动应用于同一站点上的所有页面。选择菜单中的“Use page default”取消设置。<br><img data-src="https://lengyuewusheng.com/assets/images/chrome-extensions/SetCharacterEncoding.png" alt="SetCharacterEncoding"></p><h2 id="安装地址-3"><a href="#安装地址-3" class="headerlink" title="安装地址"></a>安装地址</h2><p><a href="https://chrome.google.com/webstore/detail/set-character-encoding/bpojelgakakmcfmjfilgdlmhefphglae?hl=zh-CN">chrome 网上应用店·Set Character Encoding</a></p><h1 id="omni"><a href="#omni" class="headerlink" title="omni"></a><a href="https://github.com/alyssaxuu/omni">omni</a></h1><h2 id="插件介绍-4"><a href="#插件介绍-4" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>像Alfred管理macOS一样，使用简单的命令界面管理Chrome浏览器的选项卡、书签、浏览器历史记录、执行各种操作等。</p><h2 id="适用场景-4"><a href="#适用场景-4" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>快速查找定位页面，提升Chrome浏览器使用效率。</li></ul><h2 id="使用方法-4"><a href="#使用方法-4" class="headerlink" title="使用方法"></a>使用方法</h2><p>Ctrl+Shift+K(Mac: command+Shift+K)调起面板，通过以下命令来执行操作或过滤结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/tabs:      搜索定位当前打开的tab页</span><br><span class="line">/bookmarks: 搜索书签</span><br><span class="line">/history:   搜索浏览历史</span><br><span class="line">/remove:    删除书签或关闭标签</span><br><span class="line">/actions:   搜索所有支持的操作</span><br></pre></td></tr></table></figure><p><img data-src="https://lengyuewusheng.com/assets/images/chrome-extensions/omni.png" alt="omni"></p><h2 id="安装地址-4"><a href="#安装地址-4" class="headerlink" title="安装地址"></a>安装地址</h2><p><a href="https://chrome.google.com/webstore/detail/omni-bookmark-history-tab/mapjgeachilmcbbokkgcbgpbakaaeehi?hl=zh-CN">chrome 网上应用店·omni</a></p><h1 id="Save-to-Pocket-x2F-Add-to-Microsoft-To-Do"><a href="#Save-to-Pocket-x2F-Add-to-Microsoft-To-Do" class="headerlink" title="Save to Pocket &#x2F; Add to Microsoft To Do"></a><a href="https://github.com/Pocket/extension-save-to-pocket">Save to Pocket</a> &#x2F; <a href="https://github.com/ukhan/add-to-ms-todo">Add to Microsoft To Do</a></h1><h2 id="插件介绍-5"><a href="#插件介绍-5" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>随时收集和捕获灵感的最简单、最快的方法。在我个人看来这两个插件没有本质区别，都是快速收集有价值的信息。在使用上各有优劣，<code>Microsoft To Do</code>的访问速度更快，<code>Pocket</code>的阅读体验更好。需要强调的是，<code>Microsoft To Do</code>不是官方推出的Chrome扩展。</p><h2 id="适用场景-5"><a href="#适用场景-5" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>随时收集页面浏览过程中发现的有价值信息。</li></ul><h2 id="使用方法-5"><a href="#使用方法-5" class="headerlink" title="使用方法"></a>使用方法</h2><ul><li><a href="https://chrome.google.com/webstore/detail/add-to-microsoft-to-do/loblkkbfciiklgoblkigehhghfjfjede?hl=zh-CN">Add to Microsoft To Do</a>登录后直接通过鼠标右键菜单添加即可。</li><li><a href="https://chrome.google.com/webstore/detail/save-to-pocket/niloccemoadcdkdjlinkgdfekeahmflj?hl=zh-CN">Save to Pocket</a>保存内容3种不同的方式：<ul><li>单击工具栏中的口袋按钮;</li><li>或右键单击链接并选择“保存到 Pocket”;</li><li>或使用键盘快捷键：Ctrl+Shift+P (Windows)、Command+Shift+P (Mac)。<br><img data-src="https://lengyuewusheng.com/assets/images/chrome-extensions/SavetoPocket.png" alt="SavetoPocket"></li></ul></li></ul><h2 id="安装地址-5"><a href="#安装地址-5" class="headerlink" title="安装地址"></a>安装地址</h2><ul><li><a href="https://chrome.google.com/webstore/detail/save-to-pocket/niloccemoadcdkdjlinkgdfekeahmflj?hl=zh-CN">chrome 网上应用店·Save to Pocket</a></li><li><a href="https://chrome.google.com/webstore/detail/add-to-microsoft-to-do/loblkkbfciiklgoblkigehhghfjfjede?hl=zh-CN">chrome 网上应用店·Add to Microsoft To Do</a></li></ul><p>如有其它优质工具推荐，欢迎留言交流。</p>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;工欲善其事，必先利其器。重度工具控力荐几款小众而实用的Chrome插件。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="工具控" scheme="https://www.lengyuewusheng.com/categories/%E5%B7%A5%E5%85%B7%E6%8E%A7/"/>
    
    
    <category term="Chrome插件" scheme="https://www.lengyuewusheng.com/tags/Chrome%E6%8F%92%E4%BB%B6/"/>
    
    <category term="工具控" scheme="https://www.lengyuewusheng.com/tags/%E5%B7%A5%E5%85%B7%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>边缘计算业务部署实践</title>
    <link href="https://www.lengyuewusheng.com/%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97%E4%B8%9A%E5%8A%A1%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://www.lengyuewusheng.com/%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97%E4%B8%9A%E5%8A%A1%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5.html</id>
    <published>2022-02-20T13:43:15.000Z</published>
    <updated>2022-02-24T12:03:09.757Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>边缘计算是一种分布式计算的架构，作为云计算的延伸，通过将计算能力从中心节点下沉到靠近用户的边缘节点，提供更低延时的计算服务。边缘计算节点，距离用户更近。</p></blockquote><span id="more"></span><p>通常情况下，边缘节点之间的内网是隔离的。跟企业IDC生产环境通常也通过公网互联。直接导致的后果就是，企业级的运维保障能力和平台难以覆盖到边缘计算节点。当然任何事情都不是绝对的。比如Zabbix可以通过Zabbix-proxy实现跨网监控，Jenkins也可以通过Slave节点实现跨网构建交付。但是很多时候，出于很多原因，比如有些私有化方案，耦合内部资源或者涉及业务拆分交付等等，可能会导致企业级能力覆盖不到。此时我们不会坐等时间去解决一切问题，而是需要考虑从零到一,实现一套独立的解决方案。</p><p>如果把基于企业内网已有能力体系基础上的业务部署行为比作现代社会的基建工程，那在脱离内网能力的边缘节点部署业务，就好比在原始森林里盖房子。一切都需要从零开始就地取材。需要着重强调的是，本篇的实际背景是在<code>跨公网的多个独立网络环境</code>，<code>没有其它任何自动化基础设施</code>的情况下，实现快速部署上线一套生产可用可运维的分布式应用服务。笔者期望以此为例，梳理一下从零到一部署一套完整应用服务以及搭建功能基本完善的周边运维设施的一般思路，对缺乏业务运维经验的同学在较为全面的认识业务部署的全流程和业务运维的工作内涵方面有所启发。</p><p>以下从几个方面介绍一下相关思路和实现过程：</p><ul><li>前期的筹备和调研</li><li>生产环境的规范约定</li><li>部署到生产环境</li><li>自动化流程的建立</li><li>监控告警的设计实现</li></ul><h1 id="前期的筹备和调研"><a href="#前期的筹备和调研" class="headerlink" title="前期的筹备和调研"></a>前期的筹备和调研</h1><p>前期筹备阶段需要做大量的准备和信息收集的工作，如基准测试、成本预估、成效预测等等，此外如果是全新业务或新接手的业务，则需要通过跟业务同学深入沟通了解或者参考现有相同或相似架构的服务，对业务应用整体有较为全面的了解。便于后续过程中的整体考量和扩展性设计。</p><h2 id="了解业务架构"><a href="#了解业务架构" class="headerlink" title="了解业务架构"></a>了解业务架构</h2><p>本次部署的业务通过腾讯云覆盖全国15个边缘节点，服务器总量在200台左右。涉及nginx，各类C++业务服务。主体数据规模约100G，增量冷数据约10G，增量热数据1G以下，需要每天不定时更新。本篇主要从运维角度总结了服务部署的一般思路。因此弱化了业务细节，仅提供一张简洁的业务架构图说明部署和维护的复杂性即可。</p><p><img data-src="https://lengyuewusheng.com/assets/images/edge/business_architecture.png" alt="业务架构图"></p><h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>技术选型主要指在工具链和技术方案选择时应遵循的一些基本原则。首先应该考虑的是业务场景的匹配程度，其次是实现成本和维护成本，开源方案还需考虑社区活跃程度，最后考虑的是人的因素，如已有的知识储备情况，以及团队对技术方案认同和擅长程度。</p><h2 id="容灾设计"><a href="#容灾设计" class="headerlink" title="容灾设计"></a>容灾设计</h2><p>首先需要强调的是，这里提到的容灾是指工具链的容灾而非业务容灾。</p><p>关于容灾设计应该如何考虑。有些同学会惯性的执念于工具的高可用，实际的容灾设计是用户感知程度、服务容错能力以及容灾成本的多种因素平衡的结果，容灾能力在达到一定程度之后的提升成本可能是指数级上升的。因此出于成本考虑，很多工具链角色是单台服务器加冷备的方式，如基于Jenkins的持续交付工具，制品库，监控系统server端等。</p><p>如何规避单点带来的风险？个人考虑应该满足以下三点：</p><ul><li>首先单点上的服务不应跟外部服务器有功能耦合。如监控服务采用agent push数据就不如监控server pull的方式更易于恢复；</li><li>其次单点服务器应该在业务容忍的时间范围内实现快速替换。可以通过文件备份，如Jenkins、prometheus的服务、配置以及数据皆为文件形式存储，相比结构化数据存储就比较容易实现快速替换；</li><li>单点服务器突发故障不会对生产环境应用造成不可控的影响。如在边缘节点服务器本地设置应用数据更新的缓冲目录，更新过程中不管是制品库突发故障还是自动化引擎出现问题都不会导致服务状态未知。</li></ul><h2 id="IP资源管理和网络规划"><a href="#IP资源管理和网络规划" class="headerlink" title="IP资源管理和网络规划"></a>IP资源管理和网络规划</h2><p>对于过百服务器的业务场景，直接使用IP管理业务是不现实的。个人认为原因有三：</p><ul><li>IP地址的识别度低，直接导致的结果是使用过程中极易出错；</li><li>直接应用IP在部署阶段会增加自动化的难度；</li><li>IP的唯一性会导致配置文件难以统一。</li></ul><p>解决方案：</p><ul><li>公有云VPC环境的私有DNS服务。内网解析服务一般费用较低，可以考虑。不建议自建私域DNS，首先会对业务产生单点风险，其次维护成本较高；</li><li>本地绑hosts，为服务器设计别名，可以简化管理复杂度。别名一般由以下信息的部分或全部组成，<code>服务名以及序列号.网络类型.地区信息.产品信息.企业标识</code>。服务器别名和服务域名在设计中较为类似，尽量避免信息重复，单个字段过长等问题。本地绑hosts的方法虽然不是十分优雅，但是非常实用。对于千台以下规模的服务器治理非常有效，可以简化和规范配置文件、inventory文件以及相关自动化脚本的定义。</li></ul><p>以IP资源信息为核心，可以延展出与之相关联的服务器配置信息、业务应用信息、带宽及运营商信息、成本信息等许多基础信息，这些基础信息的简单汇总就是最原始的CMDB。</p><p>服务器IP和别名的映射信息，作为最基本和最根本的业务信息。如果不能实现平台化管理建议至少应该提交到Git中进行版本化管理。</p><p>网络规划涉及私有网络和公网IP。私有网络一般涉及网段规划和业务IP分配规划。合理的内网IP规划可以通过IP信息直接识别区域业务或应用，便于实现更好管理。由于公有云不同区域提供的默认子网网段可能冲突而且识别度较低，因此一般不建议直接使用默认子网。公网IP一般分配较随机，一般需要考虑运营商、计费模式及费用成本、带宽限制等方面。</p><h2 id="设计制品库"><a href="#设计制品库" class="headerlink" title="设计制品库"></a>设计制品库</h2><p>制品库本质上是存储制品的仓库，核心功能是存储。因此制品库可以是一个制品库平台（如：nexus、artifactory）也可以是一个存储系统甚至一台大硬盘服务器。</p><p>在考虑制品库的阶段，主要考虑以下几个方面的问题：</p><ul><li>版本管理</li><li>科学规划目录</li><li>过期制品清理</li></ul><p>具体到本次部署需求，制品库的角色实际上是一个制品缓存层，不需要长期持久化制品的历史版本。另外不存在人为直接读写制品库中的制品的情况，因此可以暂不考虑权限体系。</p><p>制品库是ci、cd的边界，因此在实际场景中该角色不可或缺。</p><h2 id="搭建堡垒机"><a href="#搭建堡垒机" class="headerlink" title="搭建堡垒机"></a>搭建堡垒机</h2><p>堡垒机是生产环境的入口。一般具有安全审计，风险拦截，权限管理等功能。在实际场景中，由于虽然会有各方面的条件限制，但我们仍需要考虑搭建堡垒机的角色，主要是实现如下功能，收紧入口降低安全风险，实现自动化，方便批处理执行。实际场景中一般应该满足以下需求：</p><ul><li>严格的安全组访问策略控制访问入口；</li><li>与生产环境必要的网络和权限互通；</li><li>快捷登录服务器的配置，通常有以下三种方式：<ul><li>密码登录。明文存储密码极易造成密码泄漏，极不推荐；</li><li>互信登录。风险阻断功能丧失，容易导致入侵风险被数倍放大；</li><li>证书登录。相较上两种方式的优势在于，证书文件可以单独管理，授予最小访问权限，用完即删。<br>严格来说，以上三种方式均有不同程度的风险隐患。但是在小规模的隔离网络环境中，在基建匮乏的现实背景下，使用证书登录相对更可取。</li></ul></li><li>批处理能力。批处理工具非常丰富，以ansible为例，在堡垒机上除了需要部署ansible环境以外，还需储备以下资源：<ul><li>inventory文件清单。以地区为维度、以服务维度等多种维度创建inventory文件，当出现紧急问题时便于快速介入；</li><li>必要的预案脚本。如部署、故障检测、信息收集、日志分析等。</li></ul></li></ul><h1 id="生产环境的规范约定"><a href="#生产环境的规范约定" class="headerlink" title="生产环境的规范约定"></a>生产环境的规范约定</h1><p>生产环境规范是运维和开发人员长期积累的最佳实践的条文描述。在前期筹备阶段就应该已经清晰明确。但由于其尤为重要，因此单独强调一下。规范约定整体参考<a href="https://www.12factor.net/zh_cn/">软件交付的12要素</a>，结合实际业务总结为以下几个方面的内容：</p><h2 id="边界规范"><a href="#边界规范" class="headerlink" title="边界规范"></a>边界规范</h2><p>  如数据制备，制品生成，配置管理等，当然如果能全流程把控最好，但是实际场景中，如果由于历史原因、现实原因、其它原因等各种原因导致无法做到全流程把控的话，就应该在尊重事实的基础上做好跟开发同学的边界约定。明确了边界就明确了责任。明确了责任之后任何事情都相对更容易推进。</p><h2 id="版本规范"><a href="#版本规范" class="headerlink" title="版本规范"></a>版本规范</h2><p>  和上游数据制作者以及应用构建者约定新版本数据和制品的版本交付规范，一般建议遵循语义化版本控制规范(SemVer)。</p><h2 id="策略规范"><a href="#策略规范" class="headerlink" title="策略规范"></a>策略规范</h2><p>  如数据制备的时间策略，数据完整性的校验方法，配置校验方法，热加载触发方式等。</p><h2 id="应用-部署-规范"><a href="#应用-部署-规范" class="headerlink" title="应用(部署)规范"></a>应用(部署)规范</h2><blockquote><p>应用部署过程中的明确可落地的规范，是实现自动化和提升稳定性的基础。</p></blockquote><ul><li>应用名，业务名称要固定，要能体现业务特点；</li><li>应用路径，包括对制品存放的路径规范，生产环境部署的路径规范以及目录层级含义；</li><li>配置文件，配置文件命名、格式、存放路径、加载方式；</li><li>服务端口约定，应支持通过参数或配置文件指定，应考虑多模块实例场景下的端口扩展性，一般不建议使用超过10000的端口，因为大流量服务需要限制端口范围避免和监听端口冲突，过大的端口会导致端口范围的减小。另外80端口只有root用户有权占用；</li><li>数据、代码、配置、日志目录的相互剥离：<ul><li>数据目录应该独立且平行于代码目录；</li><li>代码和配置应该拆分开；</li><li>代码目录下禁止保留应用日志目录；</li><li>日志和数据目录一般较大，应避免直接存放在根分区下，而应存放在数据盘分区下单独管理。</li></ul></li><li>启动方式，可以考虑以下方式：<ul><li>用systemd管理启动；</li><li>用supervisor管理进程启动；</li><li>自定义脚本启动，自定义脚本要支持在任意目录下通过相对路径或绝对路径执行。</li></ul></li><li>应用需开机启动以保证服务器重启后应用能够正常对外服务；</li><li>进程支持自动拉起，降低业务不可用时间的必要条件；</li><li>应用日志规范：<blockquote><p>应用日志规范作为应用规范的一部分，是需要在部署实施之前就明确的。</p></blockquote><ul><li>日志命名，包含日志文件名的生成规则，以及存放路径等信息；</li><li>日志滚动，主要包含两个方面的信息，一是日志文件的切分周期，二是本地日志文件保留个数；</li><li>日志字段定义，如需要基于日志信息进行监控或数据分析，应明确日志的每个字段的定义，分隔符以及关键字等信息。</li></ul></li></ul><h2 id="日志-数据回收流程规范"><a href="#日志-数据回收流程规范" class="headerlink" title="(日志)数据回收流程规范"></a>(日志)数据回收流程规范</h2><p>生产环境回传数据是常见的需求，以业务日志回传作为最典型的离线数据传输场景。此种场景需要考虑以下几个方面的因素：</p><ul><li>时效性要求。日志数据的回收应该在满足业务时效性的前提下，实现最小成本回收，因此对业务日志回收的时效性应该明确；</li><li>错峰。在满足时效性的前提下，避免带宽叠加，尤其在公有云的跨公网传输的场景；</li><li>本地压缩。根据数据规模大小，太小的数据也可能没有压缩的必要，由于压缩比较消耗资源，因此较大的数据压缩应该避免影响业务的正常运行的前提下，尽可能节省带宽；</li><li>日志滚动。避免磁盘写满。磁盘写满是生产环境中最为低级的问题，但却又极易出现，并且对应用的影响极大；</li><li>被动拉取。容灾性好。被动拉取首先可以做到日志回传流程集中管理，避免散布到生产环境的多台服务器上，另外流程更可控，主动推送的方式很难确认最新数据文件的完整性；</li><li>日志文件完整性。如果存在多个阶段的回传，要避免一个阶段的传输尚未结束，另一个阶段直接开始。</li></ul><h2 id="交付规范即可运维标准"><a href="#交付规范即可运维标准" class="headerlink" title="交付规范即可运维标准"></a>交付规范即可运维标准</h2><ul><li>安全合规。<ul><li>通过公有云的安全组访问控制策略，限制网段、IP、端口等的访问规则，在不影响业务正常运行的前提下开放最小访问权限；</li><li>避免非对外业务端口直接监听公网IP；</li><li>rsync在白名单访问的基础上增加鉴权认证、限制到具体目录读写操作的权限粒度；</li><li>配置文件中排除密码等敏感信息；</li><li>其它必要的安全考量。</li></ul></li><li>具备一定的冗余算力。在处理业务正常峰值的基础上，对于异常波动应有一定的耐受能力；</li><li>生产环境服务部署的一致性。同一个或者同一组服务的多台服务器相当于一台服务器的多个副本，即无状态部署；</li><li>生产环境无垃圾数据文件。生产环境中存留垃圾数据会对后续的维护产生不同程度的干扰，因此应及时清理；</li><li>滚动写入。所有持续写盘的进程或任务都应该具备与之搭配的在保留满足需求数据量的前提下的自动清理数据的流程，使磁盘持续具备足够的可写空间；</li><li>可扩展性考量。当应用规模增加或缩小时，不会导致整体大的调整。</li></ul><p>另外需要着重强调的是生产环境应严禁开启应用的debug模式。</p><h1 id="部署实施"><a href="#部署实施" class="headerlink" title="部署实施"></a>部署实施</h1><p>部署实施的流程大致总结如下。其中如果存在大规模数据传输过程，应该考虑和轻量的初始化操作剥离。</p><p><img data-src="https://lengyuewusheng.com/assets/images/edge/deployment_flowchart.png" alt="部署流程图"></p><p>以下将针对重要环节适当展开阐述。</p><h2 id="服务器初始化"><a href="#服务器初始化" class="headerlink" title="服务器初始化"></a>服务器初始化</h2><p>所谓服务器的初始化操作，是指在部署之前，所有服务器需都要执行的统一的定制化操作步骤。一般至少需要考虑如下几个方面：</p><ul><li>定制修改ssh、rsync服务的默认端口，如果将监听端口修改为较大的tcp端口时，应注意在开机流程中，ssh和rsync应该在业务应用启动前启动，以避免可能造成的端口占用和冲突；</li><li>初始化rsync配置，建议按照最小权限原则配置目录范围和读写权限，另外还需要考虑必要的身份鉴权；</li><li>初始化硬盘。包括新建分区和挂载目录，属于相对比较程式化的操作；</li><li>部署相关agent，如监控agent、安全相关的agent等全机群部署的基础应用；</li><li>内核参数初始化，如文件打开数限制，backlog限制，随机端口生成范围限制等等；<ul><li>内核参数优化过程中需要注意用户限制不能超过内核限制，否则将带来灾难性后果。</li></ul></li><li>其它必要的定制更改。</li></ul><h2 id="部署业务应用"><a href="#部署业务应用" class="headerlink" title="部署业务应用"></a>部署业务应用</h2><p>业务部署过程依赖于此前规划的IP、服务器别名映射信息，这是提升部署效率和降低错误率的基础。除此之外还要注意以下几点：</p><ul><li>首先实现方式，个人推荐shell + ansible ad-hoc。有些读者可能认为ansible-playbook才是规范操作和最佳实践。但是shell和ansible ad-hoc是互补的搭档，二者组合非常灵活强大，另外收集执行过程中的标准日志和错误日志方面非常方便。当然ansible-playbook的任务编排能力也非常强大，也是官方推荐的使用方式。选择没有对错，适合的就是最好的；</li><li>需要注意交互和非交互环境的环境变量差异；</li><li>部署过程应该记录日志，日志内容包括时间，执行的原始命令、标准输出、错误输出、命令退出状态码等信息。日志审计是自动化的重要基础保障；</li><li>软件定制打包是自动化和规范化的基石。将通用的优化修改集成到软件安装包中可以减少部署的复杂度。将生产环境的规范设计集成到安装包中，更容易实现和推广。当然，如果需求来了现定制打包估计是来不及的，此时可以通过原始软件包+定制逻辑脚本代替定制软件包；</li><li>数据缓冲目录。此前多次提到，数据文件较大时，使用数据缓冲目录可以屏蔽掉网络传输和本地文件拷贝之间的速度差异。同时可以隔离数据传输过程中，突发异常对生产环境的影响。</li></ul><p>交付生产的两个必要条件，一是较为完善的监控告警，二是持续交付流程的建立。</p><h1 id="自动化实现"><a href="#自动化实现" class="headerlink" title="自动化实现"></a>自动化实现</h1><p>自动化的实现需要一个自动化引擎支撑。实际上目前成熟的自动化引擎工具非常丰富，由于本次部署不涉及容器应用，因此云原生相关的解决方案暂且不提。传统的经典工具也有很多选择。比如gitlabci、Jenkins、walle、rundeck、go-task等等。但基于实际场景，对于自动化引擎，精细化的权限控制，支持自动触发、支持日志审计、支持任务队列、备份简单、GitOps等多方面的考虑。结合个人的使用经验，最后确定使用Jenkins作为自动化引擎。大方向确定之后面临的新的问题就是应该选择自由风格还是流水线任务？一般认为流水线更加优雅，扩展性更好，更易于管理。但是自由风格的任务创建简单，更易于集成插件功能。具体到边缘计算项目更适合流水线任务类型。因为随着节点的增加，任务需要持续扩展。</p><p>以下分别从业务场景和功能需求角度分析如何实现自动化。</p><h2 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h2><ul><li>自动任务。<ul><li>增量数据更新，不定时产生增量数据交付到生产环境，需支持通过接口传参触发。</li></ul></li><li>手动任务。<ul><li>代码、配置文件更新；</li><li>大规模数据更新；</li><li>数据和代码组合更新。</li></ul></li><li>更新粒度。使用Jenkinsfile定义pipeline更适配对于更新粒度的要求。<ul><li>以功能模块为粒度组合任务；</li><li>以地区为粒度组合任务。</li></ul></li></ul><h2 id="功能需求"><a href="#功能需求" class="headerlink" title="功能需求"></a>功能需求</h2><ul><li>精细化的权限控制。触发任务的用户不允许修改任务配置定义，仅允许执行和查看日志。固化流程有利于规范任务定义、推动规范落地，保障任务的低错误率和失败率；</li><li>支持自动触发。实际上是提高研效的基础。如数据的定时和不定时频繁更新，可在数据制作流程的最后一步集成交付流程的触发操作。使整个数据制作交付流程更加流畅；</li><li>支持任务队列。避免任务时空重叠产生的风险；</li><li>日志审计。是自动化的必要条件。没有日志审计的自动化带来的风险是不可想象的；</li><li>备份简单。一定程度上弥补了Jenkins单点的风险；</li><li>任务可编程和GitOps，提升效率降低风险。</li></ul><h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p><img data-src="https://lengyuewusheng.com/assets/images/edge/automation_architecture.png" alt="设计思路"></p><h2 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h2><ul><li><p>自动触发的任务<br><img data-src="https://lengyuewusheng.com/assets/images/edge/jenkins_auto.png" alt="jenkins_auto"></p></li><li><p>手动触发的任务<br><img data-src="https://lengyuewusheng.com/assets/images/edge/jenkins_manual.png" alt="jenkins_manual"></p></li><li><p>任务完成通知<br><img data-src="https://lengyuewusheng.com/assets/images/edge/mail.png" alt="jenkins_manual"></p></li></ul><h1 id="监控告警"><a href="#监控告警" class="headerlink" title="监控告警"></a>监控告警</h1><p>监控的基本功能大致分为指标数据采集、数据可视化以及告警消息推送三部分。监控选型过程中，在满足需求的基础上，需要考虑部署和维护成本。Prometheus在系统指标监控层面无疑在部署和维护方面成本都是相对较低的。原因在于它不依赖于其它组件部署，时序数据存储于本地，便于备份和恢复。另外grafana社区对于prometheus监控的dashboard模板也非常丰富，可以快速搭建出基础的监控功能。</p><p>对于nginx的监控需要第三方模块nginx-vts的支持或基于lua的metric库支持。个人比较倾向于使用vts模块，因为之前定制业务的nginx rpm包时顺带定制了vts扩展的rpm包，开箱即用，部署非常方便。nginx-vts的配置文件是相对固化的，在此不再详细展开。</p><p>对于应用级监控，如进程存活状态，进程的各类硬件资源消耗等需要引入process-exporter，学习成本稍高，但是使用非常方便属于一劳永逸的学习投入。</p><p>监控使用prometheus，告警只能使用alertmanager + webhook或mail实现。alertmanager的学习成本比较高需要对PromQL有基本的了解。入门还算容易，最大的优点还是无外部组件依赖。</p><ul><li>监控架构<br><img data-src="https://lengyuewusheng.com/assets/images/edge/alert.png" alt="监控告警架构图"></li></ul><h2 id="监控可视化"><a href="#监控可视化" class="headerlink" title="监控可视化"></a>监控可视化</h2><ul><li>系统状态。node_exporter采集的数据，非常全面，几乎涵盖了所有关系的系统指标数据；</li><li>nginx请求状态。nginx-vts模块暴露的metrics，主要关注请求量、延迟和5xx的错误率；</li><li>应用进程状态。process-exporter采集的数据展示，主要关注进程存活以及进程的资源使用情况；</li><li>业务指标状态。业务指标数据依赖于业务埋点。</li></ul><p><img data-src="https://lengyuewusheng.com/assets/images/edge/grafana.png" alt="可视化效果图"></p><h2 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h2><ul><li>基础告警。应至少涵盖服务器存活，Load状态，cpu、内存、磁盘使用率，网卡出入带宽、网络连接数等；</li><li>应用告警。业务进程存活，基础进程如crond、rsync等存活状态，nginx进程存活，nginx错误状态码请求量，nginx请求的平均响应时间等；</li><li>告警合并。适度控制告警数量，有利于更加高效地发现并处理异常；</li><li>日志审计。必要时候用于问题溯源；</li><li>阈值合理。过于敏感的告警等于没有告警；</li><li>告警实现。Prometheus + alertmanager + webhook + 企微机器人。</li></ul><h2 id="实现效果-1"><a href="#实现效果-1" class="headerlink" title="实现效果"></a>实现效果</h2><ul><li><p>prometheus alerts<br><img data-src="https://lengyuewusheng.com/assets/images/edge/prometheus.png" alt="alert"></p></li><li><p>告警通知<br><img data-src="https://lengyuewusheng.com/assets/images/edge/message.png" alt="alert"></p></li></ul><h1 id="最后总结"><a href="#最后总结" class="headerlink" title="最后总结"></a>最后总结</h1><p>一篇写下来终于领悟到什么叫眼高手低，没写之前觉得有无数观点可以输出，真正开始整理的时候才发现想把这些想法条理清楚地表述出来并不容易。在此不禁对那些默默输出原创有价值文章的人表示敬意。业务部署和写文档一样，没有实践之前觉得没有什么复杂性可言，实际实施过程中才发现很多细节问题需要通盘考虑。快糙猛的部署行为也许可以达到业务火速上线的效果。但是欠下的技术债会在很长一个周期内潜移默化的影响着业务品质。因此我们在追求业务快速迭代的同时，一定要夯实基础。尽可能避免偷工减料的行为拉低了业务稳定性。</p><p>行文至此，才发现文字已经堆积了不少，但还不确定观点是否表达清楚。在略显凌乱的文字中间，希望对缺乏业务部署经验的同学一些思路上的启发，同时也是对自己整个项目实施过程的全面总结。当然，由于个人见识和理解的局限性，造成了客观上论述的片面性，敬请各路大神不吝批评指正，进而实现对内容的持续完善。由于篇幅限制，具体的配置细节和脚本逻辑没有进一步展开。如遇到相关疑问，也欢迎线下探讨交流。</p><p>纸上得来终觉浅。所谓的经验都需要通过更多的反复实践才能有更深刻的理解。</p><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/ansible-copy%E6%A8%A1%E5%9D%97%E5%92%8Csynchronize%E6%A8%A1%E5%9D%97%E8%AF%B4%E6%98%8E%E5%8F%8A%E6%AF%94%E8%BE%83.html">Ansible copy模块和synchronize模块说明及比较</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;边缘计算是一种分布式计算的架构，作为云计算的延伸，通过将计算能力从中心节点下沉到靠近用户的边缘节点，提供更低延时的计算服务。边缘计算节点，距离用户更近。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="DevOps" scheme="https://www.lengyuewusheng.com/categories/DevOps/"/>
    
    
    <category term="运维自动化" scheme="https://www.lengyuewusheng.com/tags/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    
    <category term="Edge Computing" scheme="https://www.lengyuewusheng.com/tags/Edge-Computing/"/>
    
    <category term="公有云部署" scheme="https://www.lengyuewusheng.com/tags/%E5%85%AC%E6%9C%89%E4%BA%91%E9%83%A8%E7%BD%B2/"/>
    
  </entry>
  
  <entry>
    <title>关于用户评价功能的使用感受和设计思考</title>
    <link href="https://www.lengyuewusheng.com/%E5%85%B3%E4%BA%8E%E7%94%A8%E6%88%B7%E8%AF%84%E4%BB%B7%E5%8A%9F%E8%83%BD%E7%9A%84%E4%BD%BF%E7%94%A8%E6%84%9F%E5%8F%97%E5%92%8C%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%80%83.html"/>
    <id>https://www.lengyuewusheng.com/%E5%85%B3%E4%BA%8E%E7%94%A8%E6%88%B7%E8%AF%84%E4%BB%B7%E5%8A%9F%E8%83%BD%E7%9A%84%E4%BD%BF%E7%94%A8%E6%84%9F%E5%8F%97%E5%92%8C%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%80%83.html</id>
    <published>2021-03-28T14:19:23.000Z</published>
    <updated>2022-01-06T12:16:23.760Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>最近一段时间由于一些机缘巧合，使用了几个大的在线平台的评价功能，有一些体验很好，有一些确实改进提升的空间还很大。使用过程中触发了一些总结和反思，斗胆分享出来，供大家研判。</p></blockquote><span id="more"></span><div  align="center">    <img data-src="https://lengyuewusheng.com/assets/images/feedback.jpeg" /></div><h1 id="一些真实的不佳的评价体验"><a href="#一些真实的不佳的评价体验" class="headerlink" title="一些真实的不佳的评价体验"></a>一些真实的不佳的评价体验</h1><ul><li><p>使用某租房品牌的搬家服务，整个过程虽然体验很差，但是这里与主题无关就不细展开了。最后结单，工人师傅当面明确要求将费用类型修改，给个五星好评，并提交若干个字的描述。此时明明感觉服务体验很差，但是又不得不给五星好评；</p></li><li><p>在某电商平台购买电器，送货师傅要求将前几次的送货订单一并给出五星评价；</p></li><li><p>购买某知名电器品牌的冰箱，出现了问题，售后师傅在事先不告知的情况下，直接使用用户手机号验证码登录某某家应用，发起工单并自助结单给出满意评价。后来又遇到冰箱抽屉有损坏，申请更换冰箱抽屉，售后师傅一顿拍照取证上传，但其实我只是更换一个冰箱抽屉，而且损坏的地方那么明显，不明白为什么会搞的那么复杂。</p></li></ul><h1 id="一些真实的较好的评价体验"><a href="#一些真实的较好的评价体验" class="headerlink" title="一些真实的较好的评价体验"></a>一些真实的较好的评价体验</h1><ul><li><p>某打车品牌，打车过程中会弹窗询问用户，司机师傅是否要求用户好评；</p></li><li><p>某快餐品牌，用户用餐结束后，大约一个小时，会微信提醒用户对本次用餐进行评价，而不是结单后立刻评价。</p></li></ul><h1 id="评价功能的一些肤浅的思考"><a href="#评价功能的一些肤浅的思考" class="headerlink" title="评价功能的一些肤浅的思考"></a>评价功能的一些肤浅的思考</h1><blockquote><ul><li>评价功能是平台赋予用户的权利，初心是为了保障平台提供服务的质量，持续提升平台品质；</li><li>在实际操作过程中，平台单一的好评率量化考核维度，导致多数被评价对象过于重视对好评率，致使出现，好评率高，服务体验差的奇怪现象；</li><li>过于注重对用户好评率的考核不仅不会提升用户体验，反而会因为服务提供者以好评数据为导向的畸形形态，为用户制造不必要的不佳体验感；</li><li>平台企业的真正价值源于给用户创造的实际价值，而不是虚高的好评率。</li></ul></blockquote><h2 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h2><ul><li><p>评价功能设计过程中，应该遵循评价是用户的权利的设计初衷，而不应该将并不客观的评价结果变成平台营销的工具之一。</p></li><li><p>维护评价数据的客观性，客观的评价数据才有价值。</p></li></ul><h2 id="功能点设计"><a href="#功能点设计" class="headerlink" title="功能点设计"></a>功能点设计</h2><ul><li><p>评价功能不应该在订单结单后立刻开放，应该在订单完成后的一段时间后（如2小时、24小时）提示用户评价，这样避免用户被动评价的情况；</p></li><li><p>评价功能应该设计窗口期，窗口期内可以评价，窗口期过后可以是默认好评，主要是为了避免过度占用用户时间；</p></li><li><p>评价功能应该有自动或者人工的回访机制，确保评价的客观性；</p></li><li><p>评价内容不论匿名或实名，客观与否，都不应直接立刻反馈给被评价对象；</p></li><li><p>评价数据应该作为一个整体从统计学的角度挖掘价值，而不必针对每一条非好评内容细究原委，因为评价样本数越大客观性越强，而孤立的一条评价并不能说明问题。</p></li></ul><hr><p><em><strong>好的评价系统是一个平台持续发展和提升的不竭动力。</strong></em></p>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;最近一段时间由于一些机缘巧合，使用了几个大的在线平台的评价功能，有一些体验很好，有一些确实改进提升的空间还很大。使用过程中触发了一些总结和反思，斗胆分享出来，供大家研判。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="随思" scheme="https://www.lengyuewusheng.com/categories/%E9%9A%8F%E6%80%9D/"/>
    
    
    <category term="设计思路" scheme="https://www.lengyuewusheng.com/tags/%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/"/>
    
  </entry>
  
  <entry>
    <title>nginx常用功能配置范例</title>
    <link href="https://www.lengyuewusheng.com/nginx%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B.html"/>
    <id>https://www.lengyuewusheng.com/nginx%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B.html</id>
    <published>2019-08-31T08:47:23.000Z</published>
    <updated>2021-05-30T06:35:01.787Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><!--div  align="center"><img data-src="https://lengyuewusheng.com/images/nginx.jpg" /></div--><p><img data-src="https://lengyuewusheng.com/assets/images/nginx.png"></p><p>nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP&#x2F;UDP proxy server, originally written by Igor Sysoev.</p></blockquote><span id="more"></span><h1 id="隐藏版本号"><a href="#隐藏版本号" class="headerlink" title="隐藏版本号"></a>隐藏版本号</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx-Basic-认证"><a href="#nginx-Basic-认证" class="headerlink" title="nginx Basic 认证"></a>nginx Basic 认证</h1><ul><li><p>生成用户密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c /usr/local/nginx/conf/nginx.passwd.db admin</span><br></pre></td></tr></table></figure></li><li><p>更新密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd /usr/local/nginx/conf/nginx.passwd.db admin</span><br></pre></td></tr></table></figure></li><li><p>配置内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    auth_basic &quot;View is cheap,show me the password!&quot;;</span><br><span class="line">    auth_basic_user_file nginx.passwd.db;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="限制-http-x-forwarded-for"><a href="#限制-http-x-forwarded-for" class="headerlink" title="限制$http_x_forwarded_for"></a>限制$http_x_forwarded_for</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">set $allow false;</span><br><span class="line">if ($http_x_forwarded_for = &quot;185.199.111.153&quot;) &#123;</span><br><span class="line">  set $allow true;</span><br><span class="line">&#125;</span><br><span class="line">if ($http_x_forwarded_for ~ &quot;10.0.0.*&quot;) &#123;</span><br><span class="line">  set $allow true;</span><br><span class="line">&#125;</span><br><span class="line">if ($allow = false) &#123;</span><br><span class="line">  return 404;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="限制请求方法"><a href="#限制请求方法" class="headerlink" title="限制请求方法"></a>限制请求方法</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($request_method !~ ^(GET|POST)$ ) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="过滤特殊UA"><a href="#过滤特殊UA" class="headerlink" title="过滤特殊UA"></a>过滤特殊UA</h1><p>if ($http_user_agent ~* sqlmap|wget|curl) {<br>    return 403;<br>}</p><h1 id="图片防盗链"><a href="#图片防盗链" class="headerlink" title="图片防盗链"></a>图片防盗链</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">location /images/ &#123;</span><br><span class="line">    valid_referers none blocked lengyuewusheng.com www.lengyuewusheng.com;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return  403;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">或</span><br><span class="line">location /images/ &#123;</span><br><span class="line">    valid_referers blocked lengyuewusheng.com www.lengyuewusheng.com;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        rewrite ^/images/.*\.(gif|jpg|jpeg|png)$ /error.html last;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>“Referer”请求头为指定值时，内嵌变量$invalid_referer被设置为空字符串， 否则这个变量会被置成”1”。查找匹配时不区分大小写。</li><li>valid_referers：验证referer<ul><li>none: 允许referer为空，</li><li>blocked: 允许不带协议的请求.</li></ul></li></ul><h1 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  upstream realservers &#123;</span><br><span class="line">    server 10.0.0.1:8080 weight=3;</span><br><span class="line">    server 10.0.0.2:8080 weight=7;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    location /admin/ &#123;</span><br><span class="line">      proxy_pass http://realserver;</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx开启keepalive"><a href="#nginx开启keepalive" class="headerlink" title="nginx开启keepalive"></a>nginx开启keepalive</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">upstream realserver &#123;</span><br><span class="line">    server 10.0.0.1:8080;</span><br><span class="line">    keepalive 10;</span><br><span class="line">    keepalive_timeout 60s;    # This directive appeared in version 1.15.3.</span><br><span class="line">    keepalive_requests 100;   # This directive appeared in version 1.15.3.</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">  keepalive_timeout 75s;</span><br><span class="line">  server &#123;</span><br><span class="line">      location / &#123;</span><br><span class="line">          proxy_http_version 1.1;</span><br><span class="line">          proxy_set_header Connection &quot;&quot;;</span><br><span class="line">          proxy_pass http://realserver;</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>keepalive： 指定每个nginx worker可以保持的最大连接数量为1024，默认不设置，即nginx作为client时keepalive未生效。</p></li><li><p>proxy_http_version 1.1: 开启keepalive要求HTTP协议版本为HTTP 1.1。</p></li><li><p>proxy_set_header Connection “”: 为了兼容老的协议以及防止http头中有Connection close导致的keepalive失效，这里需要及时清掉HTTP头部的Connection。</p></li><li><p>keepalive_requests: 设置可通过一个保持连接提供服务的最大请求数。在发出最大请求数后，连接将关闭。</p></li><li><p>keepalive_timeout: </p><ul><li>upstream中的keepalive_timeoute是ngx_http_upstream_module模块中的功能，是1.15.3后的新特性，设置空闲保持连接的超时时间。</li><li>upstream外的keepalived是ngx_http_core_module模块中的功能,第一个参数是保持活动的客户机连接将在服务器端保持打开状态的超时时间。0表示禁用保持活动的客户端连接。可选的第二个参数在”Keep-Alive: timeout&#x3D;time”响应头字段中设置一个值。两个参数可以不同。</li></ul></li></ul><h1 id="nginx开启目录查看"><a href="#nginx开启目录查看" class="headerlink" title="nginx开启目录查看"></a>nginx开启目录查看</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location /download/ &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        autoindex_exact_size off;</span><br><span class="line">        autoindex_localtime on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>autoindex_exact_size： 为on(默认)时显示文件的确切大小，单位是byte；改为off显示文件大概大小，单位KB或MB或GB</p></li><li><p>autoindex_localtime： 为off(默认)时显示的文件时间为GMT时间；改为on后，显示的文件时间为服务器时间</p></li></ul><h1 id="浏览器不显示文件内容直接下载文件"><a href="#浏览器不显示文件内容直接下载文件" class="headerlink" title="浏览器不显示文件内容直接下载文件"></a>浏览器不显示文件内容直接下载文件</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($request_filename ~* ^.*?\.(txt|pdf)$) &#123;</span><br><span class="line">    add_header Content-Disposition &#x27;attachment&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx获取用户真实IP"><a href="#nginx获取用户真实IP" class="headerlink" title="nginx获取用户真实IP"></a>nginx获取用户真实IP</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set_real_ip_from  10.0.0.0/8;               #真实服务器上一级代理的IP地址或者IP段,可以写多行。</span><br><span class="line">set_real_ip_from  192.168.0.0/16;</span><br><span class="line">real_ip_header    X-Forwarded-For;          #从哪个header头检索出要的IP地址。</span><br><span class="line">real_ip_recursive on;                       #递归的排除所配置中的可信IP。</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure><ul><li>X-Forwarded-For 变量，是squid开发的，用于识别请求通过了哪些HTTP代理或负载平衡器，记录相应IP地址列表的非rfc标准，如果设置了X-Forwarded-For，那么每次经过proxy转发请求后都会有记录。</li></ul><h1 id="nginx-强制跳转https"><a href="#nginx-强制跳转https" class="headerlink" title="nginx 强制跳转https"></a>nginx 强制跳转https</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ( $scheme = http )&#123;</span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line">或</span><br><span class="line">if ( $scheme = http )&#123;</span><br><span class="line">    rewrite ^(.*)$  https://$host$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="防恶意抓取"><a href="#防恶意抓取" class="headerlink" title="防恶意抓取"></a>防恶意抓取</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    geo $limited</span><br><span class="line">    &#123;</span><br><span class="line">        default 1;</span><br><span class="line">        10.0.0.0/8 0;</span><br><span class="line">        123.207.144.220/32 0;</span><br><span class="line">        36.110.170.248/30 0;</span><br><span class="line">        118.184.170.248/30 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map $limited $limit &#123;</span><br><span class="line">        1 $binary_remote_addr;</span><br><span class="line">        0 &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    limit_req_zone $limit zone=reqids:100m rate=10r/s;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        limit_req zone=reqids burst=2 nodelay;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>geo设置白名单</li></ul><h1 id="nginx健康检查机制"><a href="#nginx健康检查机制" class="headerlink" title="nginx健康检查机制"></a>nginx健康检查机制</h1><p>check_http_expect_alive [ http_2xx | http_3xx | http_4xx | http_5xx ]<br>返回指定HTTP code，符合预期就算检测成功</p><h1 id="通过nginx查看txt文本文件乱码"><a href="#通过nginx查看txt文本文件乱码" class="headerlink" title="通过nginx查看txt文本文件乱码"></a>通过nginx查看txt文本文件乱码</h1><ul><li>文件后缀必须是.txt而不是.html,否则换行显示会有问题<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    default_type &#x27;text/html&#x27;;</span><br><span class="line">    charset utf-8,gbk;</span><br></pre></td></tr></table></figure></li></ul><h1 id="nginx代理文件下载以及时间显示问题"><a href="#nginx代理文件下载以及时间显示问题" class="headerlink" title="nginx代理文件下载以及时间显示问题"></a>nginx代理文件下载以及时间显示问题</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx-重置错误状态码"><a href="#nginx-重置错误状态码" class="headerlink" title="nginx 重置错误状态码"></a>nginx 重置错误状态码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将限制抓取导致的503重置成204</span><br><span class="line">error_page   503 =204 /50x.html;</span><br></pre></td></tr></table></figure><h1 id="nginx-steam-log-以代理etcd为例"><a href="#nginx-steam-log-以代理etcd为例" class="headerlink" title="nginx steam log(以代理etcd为例)"></a>nginx steam log(以代理etcd为例)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    log_format basic &#x27;$remote_addr [$time_local] &#x27;</span><br><span class="line">                 &#x27;$protocol $status $bytes_sent $bytes_received &#x27;</span><br><span class="line">                 &#x27;$session_time&#x27;;</span><br><span class="line"></span><br><span class="line">    log_format advanced &#x27;$remote_addr [$time_local] &#x27;</span><br><span class="line">                &#x27;$protocol $status $connection $hostname $remote_addr:$remote_port-&gt;$server_addr:$server_port $bytes_sent $bytes_received &#x27;</span><br><span class="line">                &#x27;$session_time $pid&#x27;;</span><br><span class="line"></span><br><span class="line">    log_format mini &#x27;$time_local $status $connection $session_time $hostname $bytes_sent $bytes_received&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log /var/logs/nginx/etcd.local_access_log advanced buffer=32k;</span><br><span class="line">    access_log /var/logs/nginx/status_log mini buffer=32k;</span><br><span class="line"></span><br><span class="line">    upstream stream_etcd &#123;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server etcd01.local:3490 max_conns=1000 weight=5 max_fails=2 fail_timeout=30s;</span><br><span class="line">        server etcd02.local:3490 max_conns=1000 weight=5 max_fails=2 fail_timeout=30s;</span><br><span class="line">        server etcd03.local:3490 max_conns=1000 weight=5 max_fails=2 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen        2379;</span><br><span class="line">        proxy_pass    stream_etcd;</span><br><span class="line">        proxy_timeout 3600s;</span><br><span class="line">        proxy_connect_timeout 3600s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx-try-files-amp-location"><a href="#nginx-try-files-amp-location" class="headerlink" title="nginx try_files &amp; location @"></a>nginx try_files &amp; location @</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    try_files $uri $uri/index.html $uri.html =404;</span><br><span class="line">&#125;</span><br><span class="line">---</span><br><span class="line">location / &#123;</span><br><span class="line">    alias html/;</span><br><span class="line">    try_files $uri $uri/index.html =404;</span><br><span class="line">&#125;</span><br><span class="line">---</span><br><span class="line">location / &#123;</span><br><span class="line">    try_files  $uri  $uri/  @rewriting;</span><br><span class="line">&#125;</span><br><span class="line">location @rewriting &#123;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME $document_root/WEB-INF/entry.php;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx缓存配置"><a href="#nginx缓存配置" class="headerlink" title="nginx缓存配置"></a>nginx缓存配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path /dev/shm/nginx/proxy_cache/  levels=2:2 keys_zone=keys_zone_name:1024m max_size=12g inactive=1h;</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">    proxy_cache_key $server_name$uri;</span><br><span class="line">    proxy_cache_valid 200 1h;</span><br><span class="line">    proxy_cache_min_uses 3;</span><br><span class="line">    location ~ /purge(/.*)</span><br><span class="line">    &#123;</span><br><span class="line">            allow 10.0.0.0/8;</span><br><span class="line">            deny    all;</span><br><span class="line">            proxy_cache_purge  keys_zone_name  $server_name$1$is_args$args;</span><br><span class="line">    &#125;</span><br><span class="line">    location /</span><br><span class="line">    &#123;</span><br><span class="line">proxy_cache keys_zone_name;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_set_header Connection &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx-根据UA灰度"><a href="#nginx-根据UA灰度" class="headerlink" title="nginx 根据UA灰度"></a>nginx 根据UA灰度</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line">    if ($http_user_agent = &quot;Mozilla/5.0 (xxxx)&quot;) &#123;</span><br><span class="line">        proxy_pass http://bk_gray;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://bk_main;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx-根据cookie灰度"><a href="#nginx-根据cookie灰度" class="headerlink" title="nginx 根据cookie灰度"></a>nginx 根据cookie灰度</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set $upstream &quot;upstream_default&quot;;</span><br><span class="line">if ($http_cookie ~* &quot;xxxx&quot;)&#123;</span><br><span class="line">    set $upstream upstream_a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($http_cookie ~* &quot;yyyy&quot;)&#123;</span><br><span class="line">    set $upstream upstream_b;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://$upstream;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx存活检测"><a href="#nginx存活检测" class="headerlink" title="nginx存活检测"></a>nginx存活检测</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 127.0.0.1:80;</span><br><span class="line">    check interval=3000 rise=2 fall=5 timeout=1000 default_down=false type=tcp;</span><br><span class="line">&#125;</span><br><span class="line"># interval:检查请求时间间隔</span><br><span class="line"># fall:标记失败前的连续检查失败次数</span><br><span class="line"># rise: 标记成功迁的连续检查成功次数</span><br><span class="line"># timeout: 检查请求的超时时间</span><br><span class="line"># type: 检查协议类型 tcp/http/mysql/ssl_hello/smtp/pop3/imap</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/yaoweibin/nginx_tcp_proxy_module">nginx_tcp_proxy_module</a></li></ul><h1 id="nginx-upstream-backup机制"><a href="#nginx-upstream-backup机制" class="headerlink" title="nginx upstream backup机制"></a>nginx upstream backup机制</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rewrite_log on;</span><br><span class="line">proxy_ignore_client_abort on;</span><br><span class="line"></span><br><span class="line">expires epoch;</span><br></pre></td></tr></table></figure><h1 id="default-type"><a href="#default-type" class="headerlink" title="default_type"></a>default_type</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ^~ / &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    return 200;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>直接return 200, 返回的Content-Type: application&#x2F;octet-stream,浏览器默认会下载一个空文件，如果不希望浏览器下载，需要加<code>default_type text/html;</code>配置。</li></ul><h1 id="nginx日志自动切分日志配置"><a href="#nginx日志自动切分日志配置" class="headerlink" title="nginx日志自动切分日志配置"></a>nginx日志自动切分日志配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if ( $time_iso8601 ~ &quot;^(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)T(\d&#123;2&#125;):(\d&#123;2&#125;):(\d&#123;2&#125;)&quot; ) &#123;</span><br><span class="line">    set $year $1;</span><br><span class="line">    set $month $2;</span><br><span class="line">    set $day $3;</span><br><span class="line">    set $hour $4;</span><br><span class="line">    set $minutes $5;</span><br><span class="line">    set $seconds $6;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">access_log  logs/$&#123;server_name&#125;.$year-$month-$day-$hour-access_log main;</span><br></pre></td></tr></table></figure><h1 id="fastcgi开启长连接"><a href="#fastcgi开启长连接" class="headerlink" title="fastcgi开启长连接"></a>fastcgi开启长连接</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream fastcgi_backend &#123;</span><br><span class="line">    server 127.0.0.1:9000;</span><br><span class="line">    keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location /fastcgi/ &#123;</span><br><span class="line">        fastcgi_pass fastcgi_backend;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include  fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="nginx代理websocket"><a href="#nginx代理websocket" class="headerlink" title="nginx代理websocket:"></a>nginx代理websocket:</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">location /chat/ &#123;</span><br><span class="line">    proxy_pass http://backend;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">&#125;</span><br><span class="line"># ------</span><br><span class="line">http &#123;</span><br><span class="line">    map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">        default upgrade;</span><br><span class="line">        &#x27;&#x27;      close;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        location /chat/ &#123;</span><br><span class="line">            proxy_pass http://backend;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">            proxy_set_header Connection $connection_upgrade;</span><br><span class="line">            proxy_read_timeout 86400s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li><a href="http://nginx.org/en/docs/http/websocket.html">http://nginx.org/en/docs/http/websocket.html</a></li></ul><h1 id="nginx解决前端跨域拦截"><a href="#nginx解决前端跨域拦截" class="headerlink" title="nginx解决前端跨域拦截"></a>nginx解决前端跨域拦截</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ……</span><br><span class="line">    add_header Access-Control-Allow-Origin *;</span><br><span class="line">    add_header Access-Control-Allow-Headers X-Requested-With;</span><br><span class="line">    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span><br><span class="line">    # add_header Referrer-Policy unsafe-url;</span><br><span class="line">    add_header Referrer-Policy origin-when-cross-origin;</span><br><span class="line">    ……</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>Chrome plans to switch its default policy from no-referrer-when-downgrade to strict-origin-when-cross-origin, starting in version 85.<br>Starting with Firefox 87, we set the default Referrer Policy to ‘strict-origin-when-cross-origin’ which will trim user sensitive information accessible in the URL.</p></blockquote><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><p><a href="https://ialloc.org/blog/using-nginx/">使用 Nginx - 基础配置</a></p></li><li><p><a href="https://my.oschina.net/moooofly/blog/295853">获取用户真实 ip 地址的 nginx 相关配置</a></p></li><li><p><a href="https://www.hi-linux.com/posts/53006.html">使用 Nginx 自带 Realip 模块获取用户真实 IP 地址</a></p></li><li><p><a href="http://blog.51cto.com/nolinux/1594029">Nginx实战系列之功能篇—-后端节点健康检查</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1027287">Nginx负载均衡中后端节点服务器健康检查的操作梳理</a></p></li><li><p><a href="http://nginx.org/en/docs/configure.html">官方·Building nginx from Sources</a></p></li><li><p><a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/">官方·TCP and UDP Load Balancing</a></p></li><li><p><a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html">官方·Module ngx_stream_core_module</a></p></li><li><p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html">官方·http ngx_http_core_module</a></p></li></ul><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/ngxtop%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.html">ngxtop应用实践</a></li><li><a href="https://www.lengyuewusheng.com/nginx%E9%99%90%E5%88%B6%E7%AD%96%E7%95%A5.html">nginx限制策略</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;!--div  align=&quot;center&quot;&gt;
&lt;img data-src=&quot;https://lengyuewusheng.com/images/nginx.jpg&quot; /&gt;
&lt;/div--&gt;
&lt;p&gt;&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/nginx.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP&amp;#x2F;UDP proxy server, originally written by Igor Sysoev.&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="nginx" scheme="https://www.lengyuewusheng.com/categories/nginx/"/>
    
    
    <category term="nginx" scheme="https://www.lengyuewusheng.com/tags/nginx/"/>
    
    <category term="配置范例" scheme="https://www.lengyuewusheng.com/tags/%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B/"/>
    
  </entry>
  
  <entry>
    <title>wekan开源kanban系统部署</title>
    <link href="https://www.lengyuewusheng.com/wekan%E5%BC%80%E6%BA%90kanban%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2.html"/>
    <id>https://www.lengyuewusheng.com/wekan%E5%BC%80%E6%BA%90kanban%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2.html</id>
    <published>2019-08-23T23:07:10.000Z</published>
    <updated>2020-10-14T06:29:46.954Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>Open-Source kanban.</p></blockquote><span id="more"></span><h1 id="关键安装步骤"><a href="#关键安装步骤" class="headerlink" title="关键安装步骤"></a>关键安装步骤</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum --showduplicates list snapd |expand</span><br><span class="line"></span><br><span class="line">yum -y install snapd-2.30-0.el7.centos.1.x86_64 snapd-selinux-2.30-0.el7.centos.1.noarch snap-confine-2.30-0.el7.centos.1.x86_64</span><br><span class="line"></span><br><span class="line">snap install wekan</span><br><span class="line"></span><br><span class="line"> snap list</span><br><span class="line"></span><br><span class="line">查看wekan配置</span><br><span class="line">snap get wekan</span><br><span class="line"></span><br><span class="line">snap info wekan</span><br><span class="line">snap services</span><br><span class="line"></span><br><span class="line">snap 安装指定修订版本应用</span><br><span class="line">snap refresh wekan --revision=581 --stable</span><br><span class="line"></span><br><span class="line">所有的配置选项</span><br><span class="line">wekan.help 2&gt;&amp;1 |grep &quot;\\\$&quot;</span><br></pre></td></tr></table></figure><h1 id="安装后配置"><a href="#安装后配置" class="headerlink" title="安装后配置"></a>安装后配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">snap set wekan caddy-bind-port=&#x27;80&#x27;</span><br><span class="line">snap set wekan caddy-enabled=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-sync-user-data-fieldmap=&#x27;&#123;\&quot;cn\&quot;:\&quot;name\&quot;, \&quot;mail\&quot;:\&quot;email\&quot;&#125;&#x27;</span><br><span class="line">snap set wekan mail-from=&#x27;username &lt;username@xxxx.com&gt;&#x27;</span><br><span class="line">snap set wekan mail-url=&#x27;smtp://username:passwd@mail.xxxx.com:25&#x27;</span><br><span class="line">snap set wekan mongodb-bind-ip=&#x27;127.0.0.1&#x27;</span><br><span class="line">snap set wekan port=&#x27;3001&#x27;</span><br><span class="line">snap set wekan root-url=&#x27;http://domainname&#x27;</span><br><span class="line">#-----------------------------</span><br><span class="line">snap set wekan ldap-enable=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-port=&#x27;389&#x27;</span><br><span class="line">snap set wekan ldap-host=&#x27;ldap.xxxx.com&#x27;</span><br><span class="line">snap set wekan ldap-basedn=&#x27;OU=user,OU=xxxx,DC=xxxx,DC=com&#x27;</span><br><span class="line">snap set wekan ldap-login-fallback=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-reconnect=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-timeout=&#x27;10000&#x27;</span><br><span class="line">snap set wekan ldap-idle-timeout=&#x27;10000&#x27;</span><br><span class="line">snap set wekan ldap-vonnect-timeout=&#x27;10000&#x27;</span><br><span class="line">snap set wekan ldap-authentication=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-authentication-userdn=&#x27;cn=xxxx,ou=Special_Account,ou=user,ou=xxxx,dc=xxxx,dc=com&#x27;</span><br><span class="line">snap set wekan ldap-authentication-password=&#x27;passwd&#x27;</span><br><span class="line">snap set wekan ldap-internal-log-level=&#x27;debug&#x27;</span><br><span class="line">snap set wekan ldap-background-sync=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-background-sync-interval=&#x27;100&#x27;</span><br><span class="line">snap set wekan ldap-encryption=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-reject-unauthorized=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-group-filter-enable=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-search-page-size=&#x27;0&#x27;</span><br><span class="line">snap set wekan ldap-search-size-limit=&#x27;0&#x27;</span><br><span class="line">snap set wekan ldap-user-search-filter=&#x27;&#x27;</span><br><span class="line">snap set wekan ldap-user-search-field=&#x27;sAMAccountName&#x27;</span><br><span class="line">snap set wekan ldap-user-search-scope=&#x27;&#x27;</span><br><span class="line">snap set wekan ldap-unique-identifier-field=&#x27;sAMAccountName&#x27;</span><br><span class="line">snap set wekan ldap-username-field=&#x27;displayName&#x27;</span><br><span class="line">snap set wekan ldap-sync-user-data=&#x27;false&#x27;</span><br><span class="line"># snap set wekan ldap-sync-user-data-fieldmap=&#x27;&#123;\&quot;cn\&quot;:\&quot;name\&quot;, \&quot;mail\&quot;:\&quot;email\&quot;&#125;&#x27;</span><br><span class="line">snap set wekan ldap-sync-user-data-fieldmap=&#x27;&#123;\&quot;displayName\&quot;:\&quot;name\&quot;, \&quot;mail\&quot;:\&quot;email\&quot;&#125;&#x27;</span><br><span class="line">snap set wekan ldap-merge-existing-users=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-utf8-names-slugify=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-fullname-field=displayName</span><br><span class="line">snap set wekan ldap-login-fallback=true</span><br><span class="line">snap set wekan default-authentication-method=&#x27;ldap&#x27;</span><br></pre></td></tr></table></figure><h1 id="备份与恢复数据"><a href="#备份与恢复数据" class="headerlink" title="备份与恢复数据"></a>备份与恢复数据</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">备份：</span><br><span class="line">/var/lib/snapd/snap/bin/wekan.database-backup &gt;/dev/null 2&gt;&amp;1 &amp;&amp; mv /var/snap/wekan/common/db-backups/* /data/wekan/db-backups/</span><br><span class="line"></span><br><span class="line">恢复</span><br><span class="line">wekan.database-restore /var/snap/wekan/common/db-backups/wekan-20190806T103004.backup</span><br></pre></td></tr></table></figure><h1 id="操作历史"><a href="#操作历史" class="headerlink" title="操作历史"></a>操作历史</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">diff /etc/yum.repos.d/ngompa-snapcore-el7-epel-7.repo /etc/yum.repos.d/_copr_ngompa-snapcore-el7.repo</span><br><span class="line"> rm -rf /etc/yum.repos.d/ngompa-snapcore-el7-epel-7.repo</span><br><span class="line">sudo yum install snapd</span><br><span class="line">snap install wekan</span><br><span class="line">systemctl enable --now snapd.socket</span><br><span class="line">snap install wekan</span><br><span class="line">snap set wekan root-url=&quot;http://0.0.0.0:3000/&quot;</span><br><span class="line">lsof -i :3000</span><br><span class="line">snap set wekan root-url=&quot;http://10.153.43.151:3000/wekan&quot;</span><br><span class="line">snap set wekan port=&#x27;3001&#x27;</span><br><span class="line">systemctl restart snap.wekan.wekan</span><br><span class="line">systemctl status snap.wekan.wekan</span><br><span class="line">snap set wekan.help</span><br><span class="line">wekan.help</span><br><span class="line">ll /snapcat /etc/systemd/system/snap.wekan.wekan.service</span><br><span class="line">cat /etc/systemd/system/snap.wekan.wekan.service</span><br><span class="line">sudo snap set wekan mail-url=&#x27;smtp://username:passwd@mail.xxx-inc.com:25&#x27;</span><br><span class="line">sudo snap set wekan mail-from=&#x27;xxx &lt;xxx@xxx-inc.com&gt;&#x27;</span><br><span class="line">systemctl restart snap.wekan.caddy.service</span><br><span class="line">systemctl status snap.wekan.wekan.service</span><br><span class="line">systemctl status snap.wekan.mongodb.service</span><br><span class="line">journalctl -af -u snap.wekan.caddy.service</span><br><span class="line">vim /etc/systemd/system/snap.wekan.caddy.service</span><br><span class="line"> /usr/bin/snap run wekan.caddy</span><br><span class="line">snap set wekan caddy-bind-port=80</span><br><span class="line">snap set wekan caddy-enabled=true</span><br><span class="line">systemctl status snap.wekan.caddy.service</span><br><span class="line">vim /var/snap/wekan/common/Caddyfile</span><br><span class="line">vim /var/snap/wekan/common/Caddyfile</span><br><span class="line">snap set wekan caddy-bind-port=80</span><br><span class="line">systemctl status snap.wekan.caddy.service -l</span><br><span class="line">systemctl status snap.wekan.caddy.service -l</span><br><span class="line">snap set wekan ldap-login-fallback=true</span><br><span class="line">snap get wekan</span><br><span class="line">snap set wekan root-url=http://10.153.43.151:3001/dashboard</span><br><span class="line">systemctl status snap.wekan.caddy.service -l</span><br><span class="line">systemctl status snap.wekan.wekan.service</span><br><span class="line">systemctl status snap.wekan.mongodb.service</span><br><span class="line">snap set wekan caddy-enabled=false</span><br><span class="line">snap set wekan port=80</span><br><span class="line">snap set wekan root-url=http://domainname/dashboard</span><br><span class="line">snap set wekan port=3001</span><br><span class="line">snap set wekan root-url=http://domainname</span><br><span class="line">snap set wekan mongodb-bind-ip=127.0.0.1</span><br><span class="line">systemctl restart snap.wekan.wekan.service</span><br><span class="line">systemctl status snap.wekan.wekan.service</span><br></pre></td></tr></table></figure><h1 id="LDAP配置"><a href="#LDAP配置" class="headerlink" title="LDAP配置"></a>LDAP配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">snap set wekan ldap-port=&#x27;389&#x27;</span><br><span class="line">snap set wekan ldap-host=&#x27;ldap.xxx-inc.com&#x27;</span><br><span class="line">snap set wekan ldap-basedn=&#x27;OU=user,OU=xxx,DC=xxx-inc,DC=com&#x27;</span><br><span class="line">snap set wekan ldap-login-fallback=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-reconnect=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-timeout=&#x27;10000&#x27;</span><br><span class="line">snap set wekan ldap-idle-timeout=&#x27;10000&#x27;</span><br><span class="line">snap set wekan ldap-vonnect-timeout=&#x27;10000&#x27;</span><br><span class="line">snap set wekan ldap-authentication=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-authentication-userdn=&#x27;cn=xxxxxx,ou=xxxxxx,ou=user,ou=xxx,dc=xxx-inc,dc=com&#x27;</span><br><span class="line">snap set wekan ldap-authentication-password=&#x27;passwd&#x27;</span><br><span class="line">snap set wekan ldap-internal-log-level=&#x27;debug&#x27;</span><br><span class="line">snap set wekan ldap-background-sync=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-background-sync-interval=&#x27;100&#x27;</span><br><span class="line">snap set wekan ldap-encryption=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-reject-unauthorized=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-group-filter-enable=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-search-page-size=&#x27;0&#x27;</span><br><span class="line">snap set wekan ldap-search-size-limit=&#x27;0&#x27;</span><br><span class="line">snap set wekan ldap-user-search-filter=&#x27;&#x27;</span><br><span class="line">snap set wekan ldap-user-search-field=&#x27;sAMAccountName&#x27;</span><br><span class="line">snap set wekan ldap-user-search-scope=&#x27;&#x27;</span><br><span class="line">snap set wekan ldap-unique-identifier-field=&#x27;sAMAccountName&#x27;</span><br><span class="line">snap set wekan ldap-username-field=&#x27;displayName&#x27;</span><br><span class="line">snap set wekan ldap-sync-user-data=&#x27;false&#x27;</span><br><span class="line">snap set wekan ldap-sync-user-data-fieldmap=&#x27;&#123;\&quot;displayName\&quot;:\&quot;name\&quot;, \&quot;mail\&quot;:\&quot;email\&quot;&#125;&#x27;</span><br><span class="line">snap set wekan ldap-merge-existing-users=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-utf8-names-slugify=&#x27;true&#x27;</span><br><span class="line">snap set wekan ldap-fullname-field=displayName</span><br><span class="line">snap set wekan ldap-login-fallback=true</span><br><span class="line">snap set wekan default-authentication-method=&#x27;ldap&#x27;</span><br><span class="line">EOF |bash</span><br></pre></td></tr></table></figure><h1 id="nginx代理"><a href="#nginx代理" class="headerlink" title="nginx代理"></a>nginx代理</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; wekan.conf &lt;&lt; EOF</span><br><span class="line">upstream task &#123;</span><br><span class="line">server 10.0.0.1:3001;</span><br><span class="line">&#125;</span><br><span class="line"># this section is needed to proxy web-socket connections</span><br><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">    default upgrade;</span><br><span class="line">    &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">include vhosts/vhosts.listen.addr;</span><br><span class="line"></span><br><span class="line">server_name wekan.webserver;</span><br><span class="line">access_log logs/$&#123;server_name&#125;_access_log main;</span><br><span class="line">access_log logs/status_log mini;</span><br><span class="line">charset  utf-8;</span><br><span class="line"></span><br><span class="line">error_page  404           /404.html;</span><br><span class="line">error_page   500 502 503 504  /50x.html;</span><br><span class="line"></span><br><span class="line">location = /50x.html</span><br><span class="line">&#123;</span><br><span class="line">root   html;</span><br><span class="line">&#125;</span><br><span class="line">location /server-status</span><br><span class="line">&#123;</span><br><span class="line">stub_status on;</span><br><span class="line">allow 10.0.0.0/8;</span><br><span class="line">deny all;</span><br><span class="line">&#125;</span><br><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line">      proxy_set_header   Host              $host;</span><br><span class="line">      proxy_set_header   X-Real-IP         $remote_addr;</span><br><span class="line">      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header   X-Forwarded-Proto $scheme;</span><br><span class="line">      proxy_max_temp_file_size 0;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade; # allow websockets</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">      proxy_pass         http://task;</span><br><span class="line"></span><br><span class="line">      #this is the maximum upload size</span><br><span class="line">      client_max_body_size       10m;</span><br><span class="line">      client_body_buffer_size    128k;</span><br><span class="line"></span><br><span class="line">      proxy_connect_timeout      90;</span><br><span class="line">      proxy_send_timeout         90;</span><br><span class="line">      proxy_read_timeout         90;</span><br><span class="line">      proxy_buffering            off;</span><br><span class="line">      proxy_request_buffering    off; # Required for HTTP CLI commands in Jenkins &gt; 2.54</span><br><span class="line">      proxy_set_header Connection &quot;&quot;; # Clear for keepalive</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 10 * * * /var/lib/snapd/snap/bin/wekan.database-backup &gt;/dev/null 2&gt;&amp;1 &amp;&amp; mv /var/snap/wekan/common/db-backups/* /data/wekan/db-backups/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">我们可以看到图中的loo0-loop11占用100%,我们只要清理掉一下就可以了.</span><br><span class="line">命令:</span><br><span class="line">sudo apt autoremove --purge snapd</span><br><span class="line">　命令:</span><br><span class="line">　　sudo apt autoremove --purge snapd</span><br></pre></td></tr></table></figure><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://github.com/wekan/wekan-snap/wiki/Install">官方安装文档</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;Open-Source kanban.&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="开源技术栈" scheme="https://www.lengyuewusheng.com/categories/%E5%BC%80%E6%BA%90%E6%8A%80%E6%9C%AF%E6%A0%88/"/>
    
    
    <category term="wekan" scheme="https://www.lengyuewusheng.com/tags/wekan/"/>
    
    <category term="kanban" scheme="https://www.lengyuewusheng.com/tags/kanban/"/>
    
  </entry>
  
  <entry>
    <title>tomcat调优实践</title>
    <link href="https://www.lengyuewusheng.com/tomcat%E8%B0%83%E4%BC%98%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://www.lengyuewusheng.com/tomcat%E8%B0%83%E4%BC%98%E5%AE%9E%E8%B7%B5.html</id>
    <published>2019-08-18T08:53:36.000Z</published>
    <updated>2021-01-04T13:09:14.837Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><div  align="center">    <img data-src="https://lengyuewusheng.com/assets/images/tomcat.png" /></div><p>持续整理中</p></blockquote><span id="more"></span><h1 id="调优思路"><a href="#调优思路" class="headerlink" title="调优思路"></a>调优思路</h1><ul><li><p>清空webapps</p></li><li><p>隐藏tomcat版本号</p></li><li><p>开启apr</p></li><li><p>修改随机数生成器</p></li><li><p>修改8005重启命令</p></li><li><p>禁用8009</p></li><li><p>Connector和exec优化</p></li><li><p>开机启动</p></li><li><p>systemd支持</p></li><li><p>cron自动重启自动清理日志</p></li><li><p>关闭autoDeploy</p></li><li><p>使用LD_LIBRARY_PATH替换java.library.path</p></li></ul><h1 id="关闭autoDeploy"><a href="#关闭autoDeploy" class="headerlink" title="关闭autoDeploy"></a>关闭autoDeploy</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;false&quot;&gt;</span><br></pre></td></tr></table></figure><h1 id="使用LD-LIBRARY-PATH替换java-library-path"><a href="#使用LD-LIBRARY-PATH替换java-library-path" class="headerlink" title="使用LD_LIBRARY_PATH替换java.library.path"></a>使用LD_LIBRARY_PATH替换java.library.path</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Djava.library.path=$CATALINA_HOME/extra/lib</span><br><span class="line">会覆盖系统环境变量：</span><br><span class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH/path/to//so-lib</span><br></pre></td></tr></table></figure><ul><li>添加多个值 <code>-Djava.library.path=/opt/hdf-java/build/bin:/opt/opencv-2.4.10/build/lib</code></li></ul><h1 id="隐藏版本"><a href="#隐藏版本" class="headerlink" title="隐藏版本"></a>隐藏版本</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd apache-tomcat/lib/</span><br><span class="line">unzip catalina.jar</span><br><span class="line">修改 org/apache/catalina/util/ServerInfo.properties</span><br><span class="line">增量更新jar包: jar -uvf catalina.jar org/apache/catalina/util/ServerInfo.properties</span><br></pre></td></tr></table></figure><h1 id="自定义header-Server"><a href="#自定义header-Server" class="headerlink" title="自定义header Server"></a>自定义header Server</h1><p>conf&#x2F;server.xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;  </span><br><span class="line">                    connectionTimeout=&quot;20000&quot; </span><br><span class="line">                    redirectPort=&quot;8443&quot;  </span><br><span class="line">                    URIEncoding=&quot;UTF-8&quot; </span><br><span class="line">                    useBodyEncodingForURI=&quot;true&quot; /&gt;</span><br><span class="line"></span><br><span class="line">修改后如下：</span><br><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;  </span><br><span class="line">                     connectionTimeout=&quot;20000&quot; </span><br><span class="line">                     redirectPort=&quot;8443&quot;  </span><br><span class="line">                     URIEncoding=&quot;UTF-8&quot; </span><br><span class="line">                     useBodyEncodingForURI=&quot;true&quot; </span><br><span class="line">                     server=&quot;Microsoft-IIS/6.5&quot;/&gt;</span><br></pre></td></tr></table></figure><h1 id="开启apr"><a href="#开启apr" class="headerlink" title="开启apr"></a>开启apr</h1><p>LD_LIBRARY_PATH是Linux环境变量名，该环境变量主要用于指定查找共享库（动态链接库）时除了默认路径之外的其他路径。<br>LD_RUN_PATH环境变量, 它也是把路径编译进可执行文件内，不同的是它只设置RPATH<br>  这么多搜索路径，他们有个先后顺序如下<br>  1、RUMPATH 优先级最高<br>  2、RPATH   其次<br>  3、LD_LIBRARY_PATH<br>  4、&#x2F;etc&#x2F;ld.so.cache<br>  5、&#x2F;usr&#x2F;lib&#x2F; &#x2F;lib&#x2F;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install apr-devel</span><br><span class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/apr/lib</span><br><span class="line">或者：</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Djava.library.path=/usr/local/apr/lib&quot;</span><br></pre></td></tr></table></figure><h1 id="bin-x2F-catalina-sh-stop-不生效问题"><a href="#bin-x2F-catalina-sh-stop-不生效问题" class="headerlink" title="bin&#x2F;catalina.sh stop 不生效问题"></a>bin&#x2F;catalina.sh stop 不生效问题</h1><p>在读取时，&#x2F;dev&#x2F;random设备会返回小于熵池噪声总数的随机字节。<br>&#x2F;dev&#x2F;random可生成高随机性的公钥或一次性密码本。若熵池空了，对&#x2F;dev&#x2F;random的读操作将会被阻塞，直到收集到了足够的环境噪声为止。\这样的设计使得&#x2F;dev&#x2F;random是真正的随机数发生器，提供了最大可能的随机数据熵，建议在需要生成高强度的密钥时使用。</p><p>&#x2F;dev&#x2F;random的一个副本是&#x2F;dev&#x2F;urandom（“unblocked”，非阻塞的随机数发生器），它会重复使用熵池中的数据以产生伪随机数据。<br>这表示对&#x2F;dev&#x2F;urandom的读取操作不会产生阻塞，但其输出的熵可能小于&#x2F;dev&#x2F;random的。它可以作为生成较低强度密码的伪随机数生成器，不建议用于生成高强度长期密码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/securerandom.source=file:\/dev\/random/securerandom.source=file:\/dev\/urandom/g&#x27; /usr/java/jdk1.8.0_192/jre/lib/security/java.security</span><br><span class="line">或</span><br><span class="line">-Djava.security.egd=file:/dev/./urandom</span><br></pre></td></tr></table></figure><h1 id="使bin-x2F-catalina-sh-stop-force生效"><a href="#使bin-x2F-catalina-sh-stop-force生效" class="headerlink" title="使bin&#x2F;catalina.sh stop -force生效"></a>使bin&#x2F;catalina.sh stop -force生效</h1><p>cat &gt;&gt; &#x2F;data&#x2F;webserver&#x2F;tomcat&#x2F;bin&#x2F;setenv.sh &lt;&lt; EOF<br>#!&#x2F;bin&#x2F;bash<br>CATALINA_PID&#x3D;$CATALINA_HOME&#x2F;bin&#x2F;catalina.map.pid<br>EOF</p><h1 id="Connector优化"><a href="#Connector优化" class="headerlink" title="Connector优化"></a>Connector优化</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">           maxThreads=&quot;5000&quot; </span><br><span class="line">           minSpareThreads=&quot;2500&quot; </span><br><span class="line">           maxSpareThreads=&quot;3750&quot;</span><br><span class="line">           enableLookups=&quot;false&quot;  //禁用dns解析</span><br><span class="line">           edirectPort=&quot;8443&quot; </span><br><span class="line">           acceptCount=&quot;1024&quot;</span><br><span class="line">           debug=&quot;0&quot; </span><br><span class="line">           connectionTimeout=&quot;10000&quot;</span><br><span class="line">           disableUploadTimeout=&quot;true&quot; /&gt;</span><br></pre></td></tr></table></figure><h1 id="prometheus监控jmx"><a href="#prometheus监控jmx" class="headerlink" title="prometheus监控jmx"></a>prometheus监控jmx</h1><ul><li><p><a href="https://github.com/prometheus/jmx_exporter">https://github.com/prometheus/jmx_exporter</a></p></li><li><p><a href="https://repo1.maven.org/maven2/io/prometheus/jmx/collector/0.12.0/collector-0.12.0.jar">https://repo1.maven.org/maven2/io/prometheus/jmx/collector/0.12.0/collector-0.12.0.jar</a></p></li><li><p><a href="https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_httpserver/0.12.0/jmx_prometheus_httpserver-0.12.0-jar-with-dependencies.jar">https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_httpserver/0.12.0/jmx_prometheus_httpserver-0.12.0-jar-with-dependencies.jar</a></p></li><li><p><a href="https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_httpserver/0.12.0/jmx_prometheus_httpserver-0.12.0.jar">https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_httpserver/0.12.0/jmx_prometheus_httpserver-0.12.0.jar</a></p></li><li><p><a href="https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.12.0/jmx_prometheus_javaagent-0.12.0.jar">https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.12.0/jmx_prometheus_javaagent-0.12.0.jar</a></p></li><li><p><a href="https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_httpserver/0.12.0/jmx_prometheus_httpserver-0.12.0.jar">https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_httpserver/0.12.0/jmx_prometheus_httpserver-0.12.0.jar</a></p></li><li><p><a href="https://github.com/prometheus/jmx_exporter/tree/master/example_configs">https://github.com/prometheus/jmx_exporter/tree/master/example_configs</a></p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- cat jmx.sh</span><br><span class="line">#!/usr/bin/env bash</span><br><span class="line"># Script to run a java application for testing jmx4prometheus.</span><br><span class="line"># Note: You can use localhost:5556 instead of 5556 for configuring socket hostname.</span><br><span class="line">java -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.port=5555 -jar ./jmx_prometheus_httpserver-0.12.0-jar-with-dependencies.jar 5556 ./tomcat.yml</span><br></pre></td></tr></table></figure><ul><li><p>cat setenv.sh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">CATALINA_PID=$CATALINA_HOME/bin/catalina.map.pid</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Djava.library.path=$CATALINA_HOME/extra/apr/lib</span><br><span class="line">-Djava.security.egd=file:/dev/./urandom</span><br><span class="line">-Djava.awt.headless=true&quot;</span><br><span class="line">[ -f $CATALINA_HOME/extra/catalina_opts.sh ] &amp;&amp; source $CATALINA_HOME/extra/catalina_opts.sh</span><br><span class="line">[ -f $CATALINA_HOME/extra/jmx_exporter_opts.sh ] &amp;&amp; source $CATALINA_HOME/extra/jmx_exporter_opts.sh</span><br></pre></td></tr></table></figure></li><li><p>cat jmx_exporter_opts.sh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -javaagent:/data/webserver/tomcat/extra/jmx_exporter/jmx_prometheus_javaagent-0.12.0.jar=7788:/data/webserver/tomcat/extra/jmx_exporter/tomcat.yml&quot;</span><br></pre></td></tr></table></figure></li><li><p><a href="https://www.ibm.com/support/knowledgecenter/zh/SSHS8R_8.0.0/com.ibm.worklight.installconfig.doc/install_config/t_optional_config_app_server_tomcat.html">tomcat开启jmx</a></p></li></ul><h1 id="解决验证码不显示的问题"><a href="#解决验证码不显示的问题" class="headerlink" title="解决验证码不显示的问题"></a>解决验证码不显示的问题</h1><ul><li>Headless模式是一种系统配置模式。在该模式下，系统缺少了显示设备、键盘或鼠标，一般Linux服务端使用headless mode。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Djava.awt.headless=true&quot;</span><br><span class="line">或</span><br><span class="line">System.setProperty(&quot;java.awt.headless&quot;, &quot;true&quot;);</span><br></pre></td></tr></table></figure></li></ul><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><p><a href="https://cloud.tencent.com/developer/article/1404206">https://cloud.tencent.com/developer/article/1404206</a></p></li><li><p><a href="http://lovesoo.org/tomcat-process-fails-to-stop-problem-solving.html?zyvufk=zcpgj2&amp;emjyvm=yr0rj2">http://lovesoo.org/tomcat-process-fails-to-stop-problem-solving.html?zyvufk=zcpgj2&amp;emjyvm=yr0rj2</a></p></li><li><p><a href="https://rorschachchan.github.io/2019/09/30/Tomcat8%E9%85%8D%E7%BD%AEapr/">https://rorschachchan.github.io/2019/09/30/Tomcat8%E9%85%8D%E7%BD%AEapr/</a></p></li><li><p><a href="http://www.laruence.com/2010/01/27/1265.html">http://www.laruence.com/2010/01/27/1265.html</a></p></li><li><p><a href="https://www.sohu.com/a/204046542_355142">https://www.sohu.com/a/204046542_355142</a></p></li><li><p><a href="https://www.bbsmax.com/A/o75NLyZXzW/">关于 Tomcat 的线程池的理解</a></p></li><li><p><a href="https://www.w3cschool.cn/tomcat/5tqv1k9w.html">https://www.w3cschool.cn/tomcat/5tqv1k9w.html</a></p></li><li><p><a href="https://www.alibabacloud.com/help/zh/faq-detail/37421.htm">Tomcat服务安全加固</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1173187">tomcat安全加固</a></p></li><li><p><a href="https://www.yuque.com/idevops/slhwwz/mfvpl0">prometheus 监控 tomcat</a></p></li><li><p><a href="http://xieyufei.com/2017/01/08/SERVER-OPEN-GZIP.html">服务器开启GZIP</a></p></li><li><p><a href="https://tomcat.apache.org/tomcat-9.0-doc/config/http.html">Apache Tomcat·The HTTP Connector</a></p></li><li><p><a href="https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging">Access Logging</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1103077">详解 Tomcat 的连接数与线程池</a></p></li><li><p><a href="https://blog.51cto.com/meiling/1826588">Tomcat优化配置</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzAwNTM5Njk3Mw==&mid=2247483768&idx=1&sn=23fb8e372719b626a5f5c5a6c98cfb72&chksm=9b1c01faac6b88ec2c3b975b03d50b4a7cdef5d0c84ec4d686abd93464d60f779a1373fa7f64&mpshare=1&scene=24&srcid=1115o7YJ3T32liFwWOetxYqe&sharer_sharetime=1573785651091&sharer_shareid=49ca04d76869dc1e522c1a1b20a84c86&key=a942e04100fd18a078c9258af003e3080d124c9a352555786f1ba968e08e029e37ef17fc36615f987a85542332b8032d41a00435f94369e8b31014f8c10abe7501042c6063477d314b8037e76c530ced&ascene=14&uin=MjU4NTIwODY2MA==&devicetype=Windows+10&version=62070158&lang=zh_CN&pass_ticket=z2BrPOXYDDwdKGKf8dnPrjuybJjyK869CeFHtJoQXp9eq0XjxSciWNxP9e+Ejhod">Tomcat性能调优及JVM内存工作原理</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzU0NTk2MjQyOA==&mid=2247484611&idx=1&sn=39c36f2bbabd87d47b1c8d4eb2cf9776&chksm=fb65a410cc122d0613c4f55e76a527acd5a45a66fdd071d243ac21c315ce1e2d6e840651f260&mpshare=1&scene=24&srcid=11141emsLAqdabcKtAQE6L0u&sharer_sharetime=1573745704644&sharer_shareid=49ca04d76869dc1e522c1a1b20a84c86&key=3486ba94f9a3c84a9daa93a3b19f3e84d39750a0c02d5b1307f993bb98f946ecc3c6fbb5fc3e37203e2e5d6f01fc5195c3ce4bc3e62f2de0ba2ba25cc207c7723bcde53e2dc13a3562957998878bd27c&ascene=14&uin=MjU4NTIwODY2MA==&devicetype=Windows+10&version=62070158&lang=zh_CN&pass_ticket=z2BrPOXYDDwdKGKf8dnPrjuybJjyK869CeFHtJoQXp9eq0XjxSciWNxP9e+Ejhod">tomcat 调优-生产环境必备</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzU5NTAzNjM0Mw==&mid=2247485907&idx=2&sn=53818bc549bf40ded1a03841d5a7be7c&chksm=fe79580bc90ed11d5c0311f556addf497bdb3fe618d82057c97541dc6bc77cd4cfc59eef1981&scene=1&subscene=10000&clicktime=1574088752&enterid=1574088752&ascene=0&devicetype=android-28&version=27000834&nettype=cmnet&abtest_cookie=AAACAA==&lang=zh_CN&pass_ticket=3bM/BKwG9HXfHMZLcUxTc7IYYXA6GqQhW/oLrNbJazmkYAdXv+0Uzi+3NB5K3nQM&wx_header=1">小计Tomcat的调优思路 | 必学必知</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;div  align=&quot;center&quot;&gt;    
&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/tomcat.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;持续整理中&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="tomcat" scheme="https://www.lengyuewusheng.com/categories/tomcat/"/>
    
    
    <category term="tomcat" scheme="https://www.lengyuewusheng.com/tags/tomcat/"/>
    
    <category term="jvm" scheme="https://www.lengyuewusheng.com/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>pandoc+revealjs使用Markdown编写在线PPT</title>
    <link href="https://www.lengyuewusheng.com/pandoc-revealjs%E4%BD%BF%E7%94%A8markdown%E7%BC%96%E5%86%99%E5%9C%A8%E7%BA%BFppt.html"/>
    <id>https://www.lengyuewusheng.com/pandoc-revealjs%E4%BD%BF%E7%94%A8markdown%E7%BC%96%E5%86%99%E5%9C%A8%E7%BA%BFppt.html</id>
    <published>2019-07-28T10:25:26.000Z</published>
    <updated>2020-05-20T06:46:00.806Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><div  align="center">    <img data-src="https://lengyuewusheng.com/assets/images/revealjs.jpg" /></div><p>学什么PPT，学reveal.js就够了！</p></blockquote><span id="more"></span><h2 id="revealjs"><a href="#revealjs" class="headerlink" title="revealjs"></a>revealjs</h2><iframe src="https://revealjs.com/#/" height="400px" width="95%"></iframe><h2 id="Markdown"><a href="#Markdown" class="headerlink" title="Markdown"></a>Markdown</h2><ul><li><p>文档头部元数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">% 标题</span><br><span class="line">% 作者</span><br><span class="line">% 日期</span><br></pre></td></tr></table></figure></li><li><p>分页</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--- 横向强制分页</span><br><span class="line">-- 纵向分页，通常一列可以作为一个章节。</span><br></pre></td></tr></table></figure></li></ul><h2 id="pandoc"><a href="#pandoc" class="headerlink" title="pandoc"></a>pandoc</h2><blockquote><p>pandoc是一个神奇而强大的工具，非常强大。具体使用方法，参见<a href="https://pandoc.org/MANUAL.html">官方文档</a>。使用范例，后面再陆续总结。。。</p></blockquote><h2 id="转换命令"><a href="#转换命令" class="headerlink" title="转换命令"></a>转换命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pandoc slides.md -o slides.html -t revealjs -s -V theme=beige</span><br><span class="line"></span><br><span class="line">pandoc 2019Mid-yearSummary.md -o 2019.html -t revealjs -s -V theme=sky</span><br></pre></td></tr></table></figure><h2 id="常用主题"><a href="#常用主题" class="headerlink" title="常用主题"></a>常用主题</h2><ul><li>default：（默认）深灰色背景，白色文字</li><li>beige：米色背景，深色文字</li><li>sky：天蓝色背景，白色细文字</li><li>night：黑色背景，白色粗文字</li><li>serif：浅色背景，灰色衬线文字</li><li>simple：白色背景，黑色文字</li><li>solarized：奶油色背景，深青色文字</li></ul><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><ul><li><code>p</code>：上一页</li><li><code>n</code>：下一页</li><li><code>s</code>：演示模式</li><li><code>f</code>: 全屏模式</li><li><code>b(/.)</code>: 黑屏暂停</li><li><code>o</code>: 概览模式</li><li><code>Esc</code>：退出全屏&#x2F;概览模式</li><li><code>?</code>: 快捷键帮助</li><li><code>Alt + 鼠标单击</code>：放大显示</li></ul><h2 id="演示备注"><a href="#演示备注" class="headerlink" title="演示备注"></a>演示备注</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;aside class=&quot;notes&quot;&gt;</span><br><span class="line">   备注内容</span><br><span class="line">&lt;/aside&gt;</span><br></pre></td></tr></table></figure><h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><ul><li><a href="https://www.lfhacks.com/s/revealjs.html">https://www.lfhacks.com/s/revealjs.html</a></li><li><a href="https://palmer.arkstack.cn/2017/05/RevealJs-slides%E6%BC%94%E7%A4%BA%E5%B7%A5%E5%85%B7-%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/">https://palmer.arkstack.cn/2017/05/RevealJs-slides%E6%BC%94%E7%A4%BA%E5%B7%A5%E5%85%B7-%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/</a></li><li><a href="https://vxhly.github.io/archives/8bdf06de.html">https://vxhly.github.io/archives/8bdf06de.html</a></li><li><a href="https://amito.me/2018/Using-Pandoc-to-Make-HTML-and-Beamer-Slides/">https://amito.me/2018/Using-Pandoc-to-Make-HTML-and-Beamer-Slides/</a></li><li><a href="https://github.com/luckylooke/revealjsBallTheme">https://github.com/luckylooke/revealjsBallTheme</a></li><li><a href="https://crazy-max.github.io/php7-presentation/#/">https://crazy-max.github.io/php7-presentation/#/</a></li><li><a href="https://github.com/denehyg/reveal.js-menu">https://github.com/denehyg/reveal.js-menu</a></li><li><a href="https://github.com/denehyg/reveal.js-toolbar">https://github.com/denehyg/reveal.js-toolbar</a></li><li><a href="https://github.com/byteclubfr/uncloak">https://github.com/byteclubfr/uncloak</a></li><li><a href="https://linux.cn/article-10228-1.html">https://linux.cn/article-10228-1.html</a></li><li><a href="https://pandoc.org/MANUAL.html">https://pandoc.org/MANUAL.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;div  align=&quot;center&quot;&gt;    
&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/revealjs.jpg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;学什么PPT，学reveal.js就够了！&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="开源技术栈" scheme="https://www.lengyuewusheng.com/categories/%E5%BC%80%E6%BA%90%E6%8A%80%E6%9C%AF%E6%A0%88/"/>
    
    
    <category term="pandoc" scheme="https://www.lengyuewusheng.com/tags/pandoc/"/>
    
    <category term="revealjs" scheme="https://www.lengyuewusheng.com/tags/revealjs/"/>
    
    <category term="ppt" scheme="https://www.lengyuewusheng.com/tags/ppt/"/>
    
  </entry>
  
  <entry>
    <title>prometheus监控实践</title>
    <link href="https://www.lengyuewusheng.com/prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://www.lengyuewusheng.com/prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5.html</id>
    <published>2019-07-20T06:03:24.000Z</published>
    <updated>2021-01-04T13:06:40.899Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><div  align="center">    <img data-src="https://lengyuewusheng.com/assets/images/prometheus.jpg" /></div><p>Power your metrics and alerting with a leading open-source monitoring solution.</p></blockquote><span id="more"></span><h1 id="prometheus-server端配置范例"><a href="#prometheus-server端配置范例" class="headerlink" title="prometheus server端配置范例"></a>prometheus server端配置范例</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     60s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 60s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line">  # - compute_metrics.rules</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#x27;s Prometheus itself.</span><br><span class="line"># ================================================================</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#x27;/metrics&#x27;</span><br><span class="line">    # scheme defaults to &#x27;http&#x27;.</span><br><span class="line"></span><br><span class="line">    # static_configs:</span><br><span class="line"></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;/opt/prometheus/conf/node.d/*.yml&#x27;]</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;metricslogfile&#x27;</span><br><span class="line">    metrics_path: &#x27;/metrics/logfile&#x27;</span><br><span class="line">    # metrics_path defaults to &#x27;/metrics&#x27;</span><br><span class="line">    # scheme defaults to &#x27;http&#x27;.</span><br><span class="line"></span><br><span class="line">    # static_configs:</span><br><span class="line"></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;/opt/prometheus/conf/node.d/*.yml&#x27;]</span><br><span class="line"></span><br><span class="line"># ================================================================</span><br><span class="line">  - job_name: &#x27;blackbox&#x27;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx]  # Look for a HTTP 200 response.</span><br><span class="line">    # static_configs:</span><br><span class="line">    #   - targets:</span><br><span class="line">    #     - https://123.xxxx.com    # Target to probe with http.</span><br><span class="line">    #     - http://map.xxxx.com</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;/opt/prometheus/conf/blackbox.d/*.yml&#x27;]</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox.server.local:19115  # The blackbox exporter&#x27;s real hostname:port.</span><br><span class="line"># ================================================================</span><br><span class="line">  - job_name: &#x27;mobile.xxxx.com&#x27;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx_mobile_xxxx_com]  # Look for a HTTP 200 response.</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;/opt/prometheus/conf/importantServices.d/xxxx.yml&#x27;]</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: blackbox.server.local:19115  # The blackbox exporter&#x27;s real hostname:port.</span><br><span class="line"># ================================================================</span><br><span class="line">  - job_name: &#x27;nginxstatus&#x27;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;/opt/prometheus/conf/nginx.d/*.yml&#x27;]</span><br><span class="line"># ================================================================</span><br><span class="line">  - job_name: &#x27;jenkins&#x27;</span><br><span class="line">    metrics_path: /prometheus</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - &#x27;10.142.112.144:8080&#x27;</span><br><span class="line">      labels:</span><br><span class="line">        cluster: &#x27;业务&#x27;</span><br><span class="line">        group: &#x27;产品&#x27;</span><br><span class="line"># ================================================================</span><br><span class="line">  - job_name: &#x27;prometheustatus&#x27;</span><br><span class="line">    metrics_path: /metrics</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - &#x27;127.0.0.1:19090&#x27;</span><br><span class="line">      labels:</span><br><span class="line">        cluster: &#x27;Prometheus&#x27;</span><br><span class="line">        group: &#x27;生产环境&#x27;</span><br><span class="line"># ================================================================</span><br><span class="line">  - job_name: &#x27;etcd&#x27;</span><br><span class="line">    metrics_path: /metrics</span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files: [&#x27;/opt/prometheus/conf/etcd.d/*.yml&#x27;]</span><br></pre></td></tr></table></figure><h2 id="子配置范例"><a href="#子配置范例" class="headerlink" title="子配置范例"></a>子配置范例</h2><ul><li><p>node</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- targets: [</span><br><span class="line">        &#x27;10.0.0.1:9100&#x27;,</span><br><span class="line">        &#x27;10.0.0.2:9100&#x27;,</span><br><span class="line">        &#x27;10.0.0.3:9100&#x27;,</span><br><span class="line">]</span><br><span class="line">  labels:</span><br><span class="line">    cluster: &#x27;业务&#x27;</span><br><span class="line">    group: &#x27;产品&#x27;</span><br></pre></td></tr></table></figure></li><li><p>blackbox</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- targets: [</span><br><span class="line">&#x27;http://www.xxxx.com/&#x27;,</span><br><span class="line">]</span><br><span class="line">  labels:</span><br><span class="line">    cluster: &#x27;业务&#x27;</span><br><span class="line">    group: &#x27;产品&#x27;</span><br></pre></td></tr></table></figure></li><li><p>etcd监控</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- targets: [</span><br><span class="line">    &#x27;etcd01.localhost:2379&#x27;,</span><br><span class="line">    &#x27;etcd02.localhost:2379&#x27;,</span><br><span class="line">    &#x27;etcd03.localhost:2379&#x27;,</span><br><span class="line">]</span><br><span class="line">  labels:</span><br><span class="line">    cluster: &#x27;etcd.业务&#x27;</span><br><span class="line">    group: &#x27;产品&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><h2 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h2><ul><li><a href="https://prometheus.io/docs/instrumenting/exporters/">exporters</a></li><li><h2 id="grafana模板"><a href="#grafana模板" class="headerlink" title="grafana模板"></a>grafana模板</h2><h3 id="prometheus-1"><a href="#prometheus-1" class="headerlink" title="prometheus"></a>prometheus</h3></li><li><a href="https://grafana.com/grafana/dashboards/8919">Node Exporter 0.16 + for Prometheus 监控展示看板</a></li><li><a href="https://grafana.com/grafana/dashboards/1860">Node Exporter Full</a><ul><li><a href="https://github.com/rfrail3/grafana-dashboards">CentOS5版本监控</a></li></ul></li><li><a href="https://grafana.com/grafana/dashboards/405">Node Exporter Server Metrics</a></li><li><a href="https://grafana.com/grafana/dashboards/306">jenkins状态监控</a></li></ul><h3 id="blackbox"><a href="#blackbox" class="headerlink" title="blackbox"></a>blackbox</h3><ul><li><a href="https://grafana.com/grafana/dashboards/5345">Blackbox Exporter Overview</a></li><li><a href="https://grafana.com/grafana/dashboards/7587"></a></li><li><a href="https://grafana.com/grafana/dashboards/9965">Blackbox Exporter 0.14 for Prometheus 监控展示看板</a></li></ul><h3 id="telegraf-influxdb"><a href="#telegraf-influxdb" class="headerlink" title="telegraf + influxdb"></a>telegraf + influxdb</h3><ul><li><a href="https://grafana.com/grafana/dashboards/61">Telegraf metrics</a></li><li><a href="https://grafana.com/grafana/dashboards/5955">Telegraf - system metrics</a></li><li><a href="https://grafana.com/grafana/dashboards/914">Telegraf system overview</a></li><li><a href="https://grafana.com/grafana/dashboards/317">influxdb状态监控</a></li></ul><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/linux%E5%86%85%E6%A0%B8%E5%B4%A9%E6%BA%83%E5%88%86%E6%9E%90.html">Linux内核崩溃分析</a></li><li><a href="https://www.lengyuewusheng.com/linux%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E7%9A%84%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F.html">Linux开机启动的多种实现方式</a></li><li><a href="https://blogs.kainy.cn/2010/06/网络操作系统（Linux）期末复习题/">网络操作系统（Linux）期末复习题</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;div  align=&quot;center&quot;&gt;    
&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/prometheus.jpg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;Power your metrics and alerting with a leading open-source monitoring solution.&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="prometheus" scheme="https://www.lengyuewusheng.com/categories/prometheus/"/>
    
    
    <category term="Linux" scheme="https://www.lengyuewusheng.com/tags/Linux/"/>
    
    <category term="监控" scheme="https://www.lengyuewusheng.com/tags/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="prometheus" scheme="https://www.lengyuewusheng.com/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>ngxtop应用实践</title>
    <link href="https://www.lengyuewusheng.com/ngxtop%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://www.lengyuewusheng.com/ngxtop%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.html</id>
    <published>2019-07-16T03:57:33.000Z</published>
    <updated>2021-09-28T05:03:49.740Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>挺实用。。。</p></blockquote><span id="more"></span><ul><li>操作范例<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/python/bin/ngxtop top remote_addr -c /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/python/bin/ngxtop -c /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><ul><li><p>查看前30条</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/python/bin/ngxtop -n 30 -c /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure></li><li><p>安装报错<br>ImportError: No module named ‘config_parser’</p></li><li><p>解决方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/lebinh/ngxtop.git</span><br><span class="line">cd ngxtop</span><br><span class="line">pip install .</span><br></pre></td></tr></table></figure></li></ul><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzA4Nzc4MjI4MQ==&amp;mid=403732461&amp;idx=1&amp;sn=355c5b2c4eea5fc667d910a976bc23d9&amp;scene=7&amp;key=b00bc6577437f0f5637ec152e1a9885b06338b95d65135e74cbc78d69c09655b0695f143dcfbb99626af16ddd5291d68c8441d2f8d77b962377edc86a1dc1478a07d1c4eeba5bd828e99a530ed574c7b&amp;ascene=0&amp;uin=MjU4NTIwODY2MA==&amp;devicetype=Windows+10&amp;version=62060844&amp;lang=zh_CN&amp;pass_ticket=VJ5qyiMQOdr7Vx9dh33jjUe53zQKR3FhJuWiKB+utNzqA0ZJO83cJfRurzxTLSbl">https://mp.weixin.qq.com/s?__biz=MzA4Nzc4MjI4MQ==&amp;mid=403732461&amp;idx=1&amp;sn=355c5b2c4eea5fc667d910a976bc23d9&amp;scene=7&amp;key=b00bc6577437f0f5637ec152e1a9885b06338b95d65135e74cbc78d69c09655b0695f143dcfbb99626af16ddd5291d68c8441d2f8d77b962377edc86a1dc1478a07d1c4eeba5bd828e99a530ed574c7b&amp;ascene=0&amp;uin=MjU4NTIwODY2MA%3D%3D&amp;devicetype=Windows+10&amp;version=62060844&amp;lang=zh_CN&amp;pass_ticket=VJ5qyiMQOdr7Vx9dh33jjUe53zQKR3FhJuWiKB%2ButNzqA0ZJO83cJfRurzxTLSbl</a></p></li><li><p><a href="https://www.vpser.net/manage/ngxtop.html">https://www.vpser.net/manage/ngxtop.html</a></p></li></ul><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/nginx%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B.html">nginx常用功能配置范例</a></li><li><a href="https://www.lengyuewusheng.com/nginx%E9%99%90%E5%88%B6%E7%AD%96%E7%95%A5.html">nginx限制策略</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;挺实用。。。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="工具控" scheme="https://www.lengyuewusheng.com/categories/%E5%B7%A5%E5%85%B7%E6%8E%A7/"/>
    
    
    <category term="nginx" scheme="https://www.lengyuewusheng.com/tags/nginx/"/>
    
    <category term="ngxtop" scheme="https://www.lengyuewusheng.com/tags/ngxtop/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB基础实践</title>
    <link href="https://www.lengyuewusheng.com/mongodb%E5%9F%BA%E7%A1%80%E5%AE%9E%E8%B7%B5.html"/>
    <id>https://www.lengyuewusheng.com/mongodb%E5%9F%BA%E7%A1%80%E5%AE%9E%E8%B7%B5.html</id>
    <published>2019-06-30T10:04:25.000Z</published>
    <updated>2020-10-12T10:12:41.164Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><div  align="center">    <img data-src="https://lengyuewusheng.com/assets/images/mongodb.png" /></div><p>边用边总结</p></blockquote><span id="more"></span><h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="mongo连接"><a href="#mongo连接" class="headerlink" title="mongo连接"></a>mongo连接</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo --host 127.0.0.1 --port 27017</span><br><span class="line">或</span><br><span class="line">mongo &quot;mongodb://127.0.0.1:27017&quot;</span><br></pre></td></tr></table></figure><h2 id="升级操作"><a href="#升级操作" class="headerlink" title="升级操作"></a>升级操作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.adminCommand( &#123; setFeatureCompatibilityVersion: &quot;4.0&quot; &#125; )</span><br></pre></td></tr></table></figure><h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><p>启用用户认证必须修改配置文件&#x2F;etc&#x2F;mongod.conf为：并重启服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">  authorization : enabled</span><br></pre></td></tr></table></figure><ul><li><p>创建管理员用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.createUser(&#123; user: &quot;admin&quot;, pwd: &quot;passwd&quot;, roles: [&#123; role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; &#125;] &#125;)</span><br><span class="line">db.auth(&quot;admin&quot;, &quot;passwd&quot;)</span><br><span class="line">db.getUsers()</span><br></pre></td></tr></table></figure></li><li><p>创建备份用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use testdb</span><br><span class="line">db.createUser(&#123; user: &quot;backup&quot;, pwd: &quot;passwd&quot;, roles: [&#123; role: &quot;backup&quot;, db: &quot;admin&quot; &#125;, &#123; role: &quot;restore&quot;, db: &quot;admin&quot; &#125;] &#125;)  # role中的db必须为admin</span><br></pre></td></tr></table></figure></li><li><p>查看用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.system.users.find().pretty()</span><br><span class="line">use testdb</span><br><span class="line">show users</span><br></pre></td></tr></table></figure></li><li><p>修改用户密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use xxxdb;</span><br><span class="line">db.changeUserPassword(&#x27;username&#x27;,&#x27;newpasswd&#x27;);</span><br></pre></td></tr></table></figure></li></ul><h2 id="开启-x2F-关闭监控"><a href="#开启-x2F-关闭监控" class="headerlink" title="开启&#x2F;关闭监控"></a>开启&#x2F;关闭监控</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.enableFreeMonitoring()</span><br><span class="line">db.disableFreeMonitoring()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show dbs;</span><br><span class="line">db.getCollectionNames();   #show collections;</span><br><span class="line">help</span><br></pre></td></tr></table></figure><h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="查询范例"><a href="#查询范例" class="headerlink" title="查询范例"></a>查询范例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(&#x27;gd_event&#x27;).aggregate([&#123;$group:&#123;_id:&quot;$eid&quot;,count:&#123;$sum:1&#125;&#125;&#125;,&#123; $match:&#123;count:&#123;$gt:1&#125;&#125;&#125;])</span><br><span class="line">类似sql：</span><br><span class="line">select eid as _id,count(eid) as count from gd_event group by eid having count&gt;1</span><br><span class="line"></span><br><span class="line">两个条件或运算：</span><br><span class="line">db.getCollection(&#x27;gd_event_log&#x27;).find(&#123;$or:[&#123;&quot;detail&quot;:&#123;$regex:&quot;冷月无声&quot;&#125;&#125;,&#123;&quot;info&quot;:&#123;$regex:&quot;冷月无声&quot;&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure><h2 id="mongo查询包含"><a href="#mongo查询包含" class="headerlink" title="mongo查询包含"></a>mongo查询包含</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.getCollection(&#x27;cards&#x27;).find(&#123;title:/scribe/&#125;)</span><br><span class="line">db.getCollection(&#x27;cards&#x27;).find(&#123;title:/导航/&#125;)</span><br></pre></td></tr></table></figure><h2 id="mongo启用全文索引"><a href="#mongo启用全文索引" class="headerlink" title="mongo启用全文索引"></a>mongo启用全文索引</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.adminCommand( &#123; setParameter : 1, textSearchEnabled : true &#125; )</span><br><span class="line">&#123; &quot;was&quot; : false, &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure><ul><li>默认是关闭的。否则会报错”err” : “text search not enabled”</li></ul><h2 id="索引语言支持"><a href="#索引语言支持" class="headerlink" title="索引语言支持"></a>索引语言支持</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.de.ensureIndex( &#123;txt: &quot;text&quot;&#125;, &#123;default_language: &quot;german&quot;&#125; )</span><br></pre></td></tr></table></figure><ul><li>如果希望使用其他语言，需要在创建索引时指定要使用的语言。默认是支持英文的。</li></ul><h2 id="修改主从"><a href="#修改主从" class="headerlink" title="修改主从"></a>修改主从</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">use local</span><br><span class="line">db.sources.find()</span><br><span class="line">db.sources.remove( &#123; &quot;host&quot;: &quot;旧IP:27017&quot;&#125; )</span><br></pre></td></tr></table></figure><h1 id="mongdb客户端工具"><a href="#mongdb客户端工具" class="headerlink" title="mongdb客户端工具"></a>mongdb客户端工具</h1><ul><li><a href="http://robomongo.org/">http://robomongo.org/</a></li></ul><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://www.jianshu.com/p/f5afc6488f9e">https://www.jianshu.com/p/f5afc6488f9e</a></li><li><a href="https://docs.mongodb.com/manual/reference/built-in-roles/#backup-and-restoration-roles">https://docs.mongodb.com/manual/reference/built-in-roles/#backup-and-restoration-roles</a></li><li><a href="https://docs.mongodb.com/manual/reference/configuration-options/#security.authorization">https://docs.mongodb.com/manual/reference/configuration-options/#security.authorization</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;div  align=&quot;center&quot;&gt;    
&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/mongodb.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;边用边总结&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="MongoDB" scheme="https://www.lengyuewusheng.com/categories/MongoDB/"/>
    
    
    <category term="MongoDB" scheme="https://www.lengyuewusheng.com/tags/MongoDB/"/>
    
    <category term="nosql" scheme="https://www.lengyuewusheng.com/tags/nosql/"/>
    
  </entry>
  
  <entry>
    <title>Linux内核崩溃分析</title>
    <link href="https://www.lengyuewusheng.com/linux%E5%86%85%E6%A0%B8%E5%B4%A9%E6%BA%83%E5%88%86%E6%9E%90.html"/>
    <id>https://www.lengyuewusheng.com/linux%E5%86%85%E6%A0%B8%E5%B4%A9%E6%BA%83%E5%88%86%E6%9E%90.html</id>
    <published>2019-06-08T11:43:01.000Z</published>
    <updated>2022-02-23T06:42:48.825Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><div  align="center"><img data-src="https://lengyuewusheng.com/assets/images/LinuxKernel.png" /></div><p>持续整理中。。。</p></blockquote><span id="more"></span><h1 id="崩溃现场"><a href="#崩溃现场" class="headerlink" title="崩溃现场"></a>崩溃现场</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[@bjsjs_42_92 ~]# crash /usr/lib/debug/lib/modules/3.10.0-327.el7.x86_64/vmlinux /opt/var/crash/127.0.0.1-2019-08-06-10\:16\:35/vmcore</span><br><span class="line"></span><br><span class="line">crash 7.1.2-3.el7_2.1</span><br><span class="line">Copyright (C) 2002-2014  Red Hat, Inc.</span><br><span class="line">Copyright (C) 2004, 2005, 2006, 2010  IBM Corporation</span><br><span class="line">Copyright (C) 1999-2006  Hewlett-Packard Co</span><br><span class="line">Copyright (C) 2005, 2006, 2011, 2012  Fujitsu Limited</span><br><span class="line">Copyright (C) 2006, 2007  VA Linux Systems Japan K.K.</span><br><span class="line">Copyright (C) 2005, 2011  NEC Corporation</span><br><span class="line">Copyright (C) 1999, 2002, 2007  Silicon Graphics, Inc.</span><br><span class="line">Copyright (C) 1999, 2000, 2001, 2002  Mission Critical Linux, Inc.</span><br><span class="line">This program is free software, covered by the GNU General Public License,</span><br><span class="line">and you are welcome to change it and/or distribute copies of it under</span><br><span class="line">certain conditions.  Enter &quot;help copying&quot; to see the conditions.</span><br><span class="line">This program has absolutely no warranty.  Enter &quot;help warranty&quot; for details.</span><br><span class="line"></span><br><span class="line">GNU gdb (GDB) 7.6</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;...</span><br><span class="line"></span><br><span class="line">      KERNEL: /usr/lib/debug/lib/modules/3.10.0-327.el7.x86_64/vmlinux</span><br><span class="line">    DUMPFILE: /opt/var/crash/127.0.0.1-2019-08-06-10:16:35/vmcore  [PARTIAL DUMP]</span><br><span class="line">        CPUS: 40</span><br><span class="line">        DATE: Tue Aug  6 10:16:27 2019</span><br><span class="line">      UPTIME: 390 days, 14:40:34</span><br><span class="line">LOAD AVERAGE: 81.55, 29.79, 16.87</span><br><span class="line">       TASKS: 2448</span><br><span class="line">    NODENAME: bjsjs_42_92</span><br><span class="line">     RELEASE: 3.10.0-327.el7.x86_64</span><br><span class="line">     VERSION: #1 SMP Thu Nov 19 22:10:57 UTC 2015</span><br><span class="line">     MACHINE: x86_64  (2199 Mhz)</span><br><span class="line">      MEMORY: 127.9 GB</span><br><span class="line">       PANIC: &quot;kernel BUG at fs/buffer.c:1280!&quot;</span><br><span class="line">         PID: 57502</span><br><span class="line">     COMMAND: &quot;java&quot;</span><br><span class="line">        TASK: ffff88201a2eb980  [THREAD_INFO: ffff880f7566c000]</span><br><span class="line">         CPU: 26</span><br><span class="line">       STATE:  (PANIC)</span><br><span class="line"></span><br><span class="line">crash&gt; bt</span><br><span class="line">PID: 57502  TASK: ffff88201a2eb980  CPU: 26  COMMAND: &quot;java&quot;</span><br><span class="line"> #0 [ffff880f7566f5a8] machine_kexec at ffffffff81051beb</span><br><span class="line"> #1 [ffff880f7566f608] crash_kexec at ffffffff810f2542</span><br><span class="line"> #2 [ffff880f7566f6d8] oops_end at ffffffff8163e1a8</span><br><span class="line"> #3 [ffff880f7566f700] die at ffffffff8101859b</span><br><span class="line"> #4 [ffff880f7566f730] do_trap at ffffffff8163d860</span><br><span class="line"> #5 [ffff880f7566f780] do_invalid_op at ffffffff81015204</span><br><span class="line"> #6 [ffff880f7566f830] invalid_op at ffffffff8164701e</span><br><span class="line">    [exception RIP: check_irqs_on+4]</span><br><span class="line">    RIP: ffffffff816326d1  RSP: ffff880f7566f8e8  RFLAGS: 00010046</span><br><span class="line">    RAX: 0000000000000096  RBX: ffff8810092d9110  RCX: ffff880ee7d05800</span><br><span class="line">    RDX: 0000000000001000  RSI: 000000000090014a  RDI: ffff880f8cf4b740</span><br><span class="line">    RBP: ffff880f7566f8e8   R8: 0000000000000004   R9: 0000000000000004</span><br><span class="line">    R10: ffff880ee7d05800  R11: ffff880f7566f9e8  R12: ffff880f8cf4b740</span><br><span class="line">    R13: 0000000000001000  R14: ffff8801df370800  R15: 0000000000000010</span><br><span class="line">    ORIG_RAX: ffffffffffffffff  CS: 0010  SS: 0018</span><br><span class="line"> #7 [ffff880f7566f8f0] __find_get_block at ffffffff81212c85</span><br><span class="line"> #8 [ffff880f7566f910] __getblk at ffffffff81212cb5</span><br><span class="line"> #9 [ffff880f7566f970] __ext4_get_inode_loc at ffffffffa0373030 [ext4]</span><br><span class="line">#10 [ffff880f7566f9d8] ext4_get_inode_loc at ffffffffa0374dbd [ext4]</span><br><span class="line">#11 [ffff880f7566f9e8] ext4_reserve_inode_write at ffffffffa0376906 [ext4]</span><br><span class="line">#12 [ffff880f7566fa18] ext4_mark_inode_dirty at ffffffffa03769d3 [ext4]</span><br><span class="line">#13 [ffff880f7566fa70] ext4_writepages at ffffffffa0377567 [ext4]</span><br><span class="line">#14 [ffff880f7566fba8] do_writepages at ffffffff811758fe</span><br><span class="line">#15 [ffff880f7566fbb8] __filemap_fdatawrite_range at ffffffff8116a685</span><br><span class="line">#16 [ffff880f7566fc08] filemap_flush at ffffffff8116a74c</span><br><span class="line">#17 [ffff880f7566fc18] ext4_alloc_da_blocks at ffffffffa0374a8c [ext4]</span><br><span class="line">#18 [ffff880f7566fc38] ext4_release_file at ffffffffa036df89 [ext4]</span><br><span class="line">#19 [ffff880f7566fc60] __fput at ffffffff811e0329</span><br><span class="line">#20 [ffff880f7566fca8] ____fput at ffffffff811e05ee</span><br><span class="line">#21 [ffff880f7566fcb8] task_work_run at ffffffff810a22f4</span><br><span class="line">#22 [ffff880f7566fce8] do_exit at ffffffff810815eb</span><br><span class="line">#23 [ffff880f7566fd78] do_group_exit at ffffffff81081dff</span><br><span class="line">#24 [ffff880f7566fda8] get_signal_to_deliver at ffffffff81092c10</span><br><span class="line">#25 [ffff880f7566fe40] do_signal at ffffffff81014417</span><br><span class="line">#26 [ffff880f7566ff30] do_notify_resume at ffffffff81014adf</span><br><span class="line">#27 [ffff880f7566ff50] retint_signal at ffffffff8163d1fc</span><br><span class="line">    RIP: 00007f3db495ee17  RSP: 00007f3cbc8a20f0  RFLAGS: 00010246</span><br><span class="line">    RAX: 0000000000000006  RBX: 00007f3cbc8a2430  RCX: 0000000000000001</span><br><span class="line">    RDX: 00007f3cbc99f700  RSI: 0000000000000008  RDI: 0000000000000000</span><br><span class="line">    RBP: 00007f3cbc8a2220   R8: 00007f3cbc8a25f0   R9: 00007f3cbc8a24c0</span><br><span class="line">    R10: 00000000fffffe00  R11: 0000000000000000  R12: 000000000000000b</span><br><span class="line">    R13: 00007f3cbc8a24c0  R14: 00007f3cbc8a2430  R15: 00007f3db48ee2c5</span><br><span class="line">    ORIG_RAX: ffffffffffffffff  CS: 0033  SS: 002b</span><br><span class="line">crash&gt;</span><br></pre></td></tr></table></figure><h1 id="字段解释"><a href="#字段解释" class="headerlink" title="字段解释"></a>字段解释</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">KERNEL: 系统崩溃时运行的 kernel 文件</span><br><span class="line"></span><br><span class="line">DUMPFILE: 内核转储文件</span><br><span class="line"></span><br><span class="line">CPUS: 所在机器的 CPU 数量</span><br><span class="line"></span><br><span class="line">DATE: 系统崩溃的时间</span><br><span class="line"></span><br><span class="line">TASKS: 系统崩溃时内存中的任务数</span><br><span class="line"></span><br><span class="line">NODENAME: 崩溃的系统主机名</span><br><span class="line"></span><br><span class="line">RELEASE: 和 VERSION: 内核版本号</span><br><span class="line"></span><br><span class="line">MACHINE: CPU 架构</span><br><span class="line"></span><br><span class="line">MEMORY: 崩溃主机的物理内存</span><br><span class="line"></span><br><span class="line">PANIC: 崩溃类型，常见的崩溃类型包括：</span><br><span class="line"></span><br><span class="line">SysRq (System Request)：通过魔法组合键导致的系统崩溃，通常是测试使用。通过 echo c &gt; /proc/sysrq-trigger，就可以触发系统崩溃。</span><br><span class="line"></span><br><span class="line">oops：可以看成是内核级的 Segmentation Fault。应用程序如果进行了非法内存访问或执行了非法指令，会得到 Segfault 信号，一般行为是 coredump，应用程序也可以自己截获 Segfault 信号，自行处理。如果内核自己犯了这样的错误，则会弹出 oops 信息。</span><br></pre></td></tr></table></figure><h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/yum.repos.d/CentOS-Debug.repo  &lt;&lt;EOF</span><br><span class="line">[CentOS-Debug]</span><br><span class="line">name=CentOS-$releasever - DebugInfo</span><br><span class="line">baseurl=http://debuginfo.centos.org/\$releasever/\$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">protect=1</span><br><span class="line">priority=1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum --enablerepo=CentOS-Debug install -y kernel-debuginfo-$(uname -r)</span><br><span class="line"></span><br><span class="line">debuginfo-install glibc</span><br><span class="line"></span><br><span class="line">vmcore crash</span><br></pre></td></tr></table></figure><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><p><a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1564573323&amp;ver=1762&amp;signature=eYQiG0V4e3pgc5iydmtd*UEuhY7rohGi9zaL*RC0WEfAiCVkC4t1brOW0hsLGkaT3Fb54tubjVVihDE24JBc3TDelUB8VS3dXWmA5oQSE8HyC*j7Cu8KTjfSmoYkL3wN&amp;new=1">https://mp.weixin.qq.com/s?src=11&amp;timestamp=1564573323&amp;ver=1762&amp;signature=eYQiG0V4e3pgc5iydmtd*UEuhY7rohGi9zaL*RC0WEfAiCVkC4t1brOW0hsLGkaT3Fb54tubjVVihDE24JBc3TDelUB8VS3dXWmA5oQSE8HyC*j7Cu8KTjfSmoYkL3wN&amp;new=1</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1564546192&amp;ver=1761&amp;signature=4arrExz*PZo7Q3bQh5JnHWGSHOFGVdyWcc-WLOHUnHdNZoX6C0Abn*ENOjxlyt50u03ahhItFz7sj7wdGswCnLgOJ-HJBX1lEp8K2IlHxBggA8ZbcfAWj76YroR6wifv&amp;new=1">https://mp.weixin.qq.com/s?src=11&amp;timestamp=1564546192&amp;ver=1761&amp;signature=4arrExz*PZo7Q3bQh5JnHWGSHOFGVdyWcc-WLOHUnHdNZoX6C0Abn*ENOjxlyt50u03ahhItFz7sj7wdGswCnLgOJ-HJBX1lEp8K2IlHxBggA8ZbcfAWj76YroR6wifv&amp;new=1</a></p></li><li><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-kdump1/index.html">https://www.ibm.com/developerworks/cn/linux/l-cn-kdump1/index.html</a></p></li><li><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-kdump3/index.html">https://www.ibm.com/developerworks/cn/linux/l-cn-kdump3/index.html</a></p></li><li><p><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-kdump4/index.html">https://www.ibm.com/developerworks/cn/linux/l-cn-kdump4/index.html</a></p></li><li><p><a href="https://www.jianshu.com/p/5b4ef8112b97">https://www.jianshu.com/p/5b4ef8112b97</a></p></li><li><p><a href="https://linux.cn/article-8737-1.html">https://linux.cn/article-8737-1.html</a></p></li><li><p><a href="https://blog.csdn.net/yuanfang_way/article/details/77987399">https://blog.csdn.net/yuanfang_way/article/details/77987399</a></p></li><li><p><a href="https://yq.aliyun.com/articles/483967">https://yq.aliyun.com/articles/483967</a></p></li><li><p><a href="https://xiaoyeshiyu.github.io/linux/fae/2017/05/11/%E5%AE%9E%E4%BE%8B%E4%BD%BF%E7%94%A8crash%E5%88%86%E6%9E%90Kdump%E8%BD%AC%E5%82%A8kernel%E5%B4%A9%E6%BA%83%E5%86%85%E6%A0%B8/">https://xiaoyeshiyu.github.io/linux/fae/2017/05/11/%E5%AE%9E%E4%BE%8B%E4%BD%BF%E7%94%A8crash%E5%88%86%E6%9E%90Kdump%E8%BD%AC%E5%82%A8kernel%E5%B4%A9%E6%BA%83%E5%86%85%E6%A0%B8/</a></p></li></ul><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5.html">prometheus监控实践</a></li><li><a href="https://www.lengyuewusheng.com/linux%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E7%9A%84%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F.html">Linux开机启动的多种实现方式</a></li><li><a href="https://blogs.kainy.cn/2010/06/网络操作系统（Linux）期末复习题/">网络操作系统（Linux）期末复习题</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;div  align=&quot;center&quot;&gt;
&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/LinuxKernel.png&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;持续整理中。。。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://www.lengyuewusheng.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://www.lengyuewusheng.com/tags/Linux/"/>
    
    <category term="crash" scheme="https://www.lengyuewusheng.com/tags/crash/"/>
    
  </entry>
  
  <entry>
    <title>常用Notebook使用笔记</title>
    <link href="https://www.lengyuewusheng.com/%E5%B8%B8%E7%94%A8notebook%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0.html"/>
    <id>https://www.lengyuewusheng.com/%E5%B8%B8%E7%94%A8notebook%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0.html</id>
    <published>2019-06-02T04:25:42.000Z</published>
    <updated>2020-08-30T10:13:34.323Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>基础备忘</p></blockquote><span id="more"></span><h1 id="jupyter"><a href="#jupyter" class="headerlink" title="jupyter"></a>jupyter</h1><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul><li><p>安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jupyterthemes</span><br></pre></td></tr></table></figure></li><li><p>列出主题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jt -l</span><br></pre></td></tr></table></figure></li><li><p>选择主题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jt -t grade3     #白</span><br><span class="line">jt -t solarizedl #浅土黄</span><br><span class="line">jt -t gruvboxl   #深土黄</span><br><span class="line">jt -t chesterish #深蓝</span><br><span class="line">jt -t solarizedd #深绿</span><br><span class="line">jt -t oceans16   #深灰</span><br><span class="line">jt -t monokai    #黑白</span><br><span class="line">jt -t gruvboxd   #黑黄</span><br><span class="line">jt -t onedork    #黑灰</span><br></pre></td></tr></table></figure></li><li><p>代码转PPT</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter nbconvert *.ipynb --to slides --post serve</span><br></pre></td></tr></table></figure></li><li><p>绑定IP端口启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter notebook --ip=10.0.0.1 --port=10001</span><br></pre></td></tr></table></figure></li><li><p>指定目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter notebook --ip=10.0.0.1 --port=10001 nibilaoyedenotebook</span><br></pre></td></tr></table></figure></li><li><p>创建密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jupyter notebook --generate-config</span><br><span class="line">jupyter notebook password --ip=10.0.0.1 --port=10001</span><br></pre></td></tr></table></figure></li><li><p>插件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">debugger</span><br><span class="line">jupyterlab-chart-editor</span><br><span class="line">toc</span><br><span class="line">jupyterlab-drawio</span><br><span class="line">jupyterlab-execute-time</span><br><span class="line">jupyterlab_filetree</span><br><span class="line">jupyterlab_go_to_definition</span><br></pre></td></tr></table></figure><p> 列出插件列表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jupyter --version</span><br><span class="line"></span><br><span class="line">jupyter labextension list</span><br></pre></td></tr></table></figure></li></ul><h1 id="zeppelin"><a href="#zeppelin" class="headerlink" title="zeppelin"></a>zeppelin</h1><h2 id="ldap-认证"><a href="#ldap-认证" class="headerlink" title="ldap 认证"></a>ldap 认证</h2><ul><li>userDnTemplate中的{0}表示登录时输入的用户名,</li><li>conf&#x2F;zeppelin-site.xml修改zeppelin.anonymous.allowed属性为false</li><li>ldapRealm.contextFactory.authenticationMechanism后面的赋值选项<ul><li>none</li><li>simple</li><li>SASL</li><li>DIGEST-MD5<ul><li><a href="https://github.com/apache/zeppelin/pull/2331">https://github.com/apache/zeppelin/pull/2331</a></li></ul></li></ul></li></ul><h2 id="nginx代理关键配置"><a href="#nginx代理关键配置" class="headerlink" title="nginx代理关键配置"></a>nginx代理关键配置</h2><ul><li><p>zeppelin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat conf/zeppelin-site.xml</span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;zeppelin.server.context.path&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;/zeppelin/&lt;/value&gt;</span><br><span class="line">  &lt;description&gt;Context Path of the Web Application&lt;/description&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>nginx</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream zeppelin &#123;</span><br><span class="line">        server 10.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /zeppelin</span><br><span class="line">&#123;</span><br><span class="line">    proxy_pass http://zeppelin;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Forwarded-Host $host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">&#125;</span><br><span class="line">location /zeppelin/ws &#123;  # For websocket support</span><br><span class="line">    proxy_pass http://zeppelin;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade websocket;</span><br><span class="line">    proxy_set_header Connection upgrade;</span><br><span class="line">    proxy_read_timeout 86400;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><p>-<a href="https://nbviewer.jupyter.org/">upyter Notebooks 共享社区</a></p><ul><li><p><a href="https://jupyter-notebook.readthedocs.io/en/stable/security.html#alternatives-to-token-authentication">https://jupyter-notebook.readthedocs.io/en/stable/security.html#alternatives-to-token-authentication</a></p></li><li><p><a href="https://zeppelin.apache.org/docs/0.8.0/setup/security/shiro_authentication.html">https://zeppelin.apache.org/docs/0.8.0/setup/security/shiro_authentication.html</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;基础备忘&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="开源技术栈" scheme="https://www.lengyuewusheng.com/categories/%E5%BC%80%E6%BA%90%E6%8A%80%E6%9C%AF%E6%A0%88/"/>
    
    
    <category term="jupyter" scheme="https://www.lengyuewusheng.com/tags/jupyter/"/>
    
    <category term="zeppelin" scheme="https://www.lengyuewusheng.com/tags/zeppelin/"/>
    
  </entry>
  
  <entry>
    <title>自签SSL证书</title>
    <link href="https://www.lengyuewusheng.com/%E8%87%AA%E7%AD%BEssl%E8%AF%81%E4%B9%A6.html"/>
    <id>https://www.lengyuewusheng.com/%E8%87%AA%E7%AD%BEssl%E8%AF%81%E4%B9%A6.html</id>
    <published>2019-05-26T06:38:29.000Z</published>
    <updated>2020-05-20T06:47:07.747Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><div  align="center">    <img data-src="https://lengyuewusheng.com/assets/images/ssl.jpeg" /></div><p>devops 必备技能</p></blockquote><span id="more"></span><ul><li><p>查看当前系统使用的 OpenSSL 版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure></li><li><p>获取完整的版本信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version -a</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>X.509 是密码学里公钥证书的格式标准。一般包含三类文件，key，csr，crt。</p></blockquote><ul><li>key是私用密钥，openssl格式，通常是rsa算法。</li><li>csr是证书请求文件，用于申请证书。在制作csr文件的时候，必须使用自己的私钥来签署申请，还可以设定一个密钥。</li><li>crt是CA认证后的证书文件（windows下面的csr，其实是crt），签署人用自己的key给你签署的凭证。</li></ul><h1 id="证书创建过程"><a href="#证书创建过程" class="headerlink" title="证书创建过程"></a>证书创建过程</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx/conf/cert</span><br><span class="line">cd /usr/local/nginx/conf/cert</span><br><span class="line"></span><br><span class="line">#创建RSA私有密钥</span><br><span class="line">openssl genrsa  -out domainName.key 2048</span><br><span class="line"># 创建CSR(为申请数字服务器证书而发送至证书颁发机构 (CA) 的文件)</span><br><span class="line">openssl req -out domainName.csr -key domainName.key -new -sha256</span><br><span class="line">mv domainName.key domainName.origin.key</span><br><span class="line"># 删除RSA私钥密码</span><br><span class="line">openssl rsa -in domainName.origin.key -out domainName.key</span><br><span class="line"># 请使用 openssl x509 对证书进行签名(使用私钥和签名请求创建的公有证书)</span><br><span class="line">openssl x509 -req -sha256 -days 3650 -in domainName.csr -signkey domainName.key -out domainName.crt</span><br></pre></td></tr></table></figure><h1 id="nginx相关配置"><a href="#nginx相关配置" class="headerlink" title="nginx相关配置"></a>nginx相关配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">   listen 443 ssl;</span><br><span class="line">   ssl_certificate     /usr/local/nginx/conf/cert/domainName.crt;</span><br><span class="line">   ssl_certificate_key  /usr/local/nginx/conf/cert/domainName.key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><a href="https://certbot.eff.org/lets-encrypt/centosrhel7-nginx">certbot生成CentOS7证书</a></li><li><a href="https://certbot.eff.org/docs/using.html#nginx">certbot官方文档</a></li><li><a href="https://www.openssl.org/docs/man1.1.1/man1/">OpenSSL commands·官方文档</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/elasticbeanstalk/latest/dg/configuring-https-ssl.html">创建和签名 X509 证书</a></li><li><a href="https://www.jianshu.com/p/f5d9d778d9dc">openssl 生成nginx 证书</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;div  align=&quot;center&quot;&gt;    
&lt;img data-src=&quot;https://lengyuewusheng.com/assets/images/ssl.jpeg&quot; /&gt;
&lt;/div&gt;

&lt;p&gt;devops 必备技能&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="openssl" scheme="https://www.lengyuewusheng.com/tags/openssl/"/>
    
    <category term="https" scheme="https://www.lengyuewusheng.com/tags/https/"/>
    
  </entry>
  
  <entry>
    <title>开源论坛技术栈</title>
    <link href="https://www.lengyuewusheng.com/%E5%BC%80%E6%BA%90%E8%AE%BA%E5%9D%9B%E6%8A%80%E6%9C%AF%E6%A0%88.html"/>
    <id>https://www.lengyuewusheng.com/%E5%BC%80%E6%BA%90%E8%AE%BA%E5%9D%9B%E6%8A%80%E6%9C%AF%E6%A0%88.html</id>
    <published>2019-05-19T12:18:06.000Z</published>
    <updated>2020-10-13T04:20:11.752Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>摘要内容</p></blockquote><span id="more"></span><h1 id="nodebb"><a href="#nodebb" class="headerlink" title="nodebb"></a>nodebb</h1><h2 id="命令行安装-x2F-启-x2F-停插件"><a href="#命令行安装-x2F-启-x2F-停插件" class="headerlink" title="命令行安装&#x2F;启&#x2F;停插件"></a>命令行安装&#x2F;启&#x2F;停插件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 列出插件列表</span><br><span class="line">./nodebb plugins</span><br><span class="line">npm install nodebb-plugin-office-ldap</span><br><span class="line">./nodebb reset --plugin nodebb-plugin-office-ldap</span><br><span class="line">./nodebb restart</span><br><span class="line">./nodebb activate nodebb-plugin-office-ldap</span><br><span class="line">./nodebb restart</span><br></pre></td></tr></table></figure><h2 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crontab:</span><br><span class="line">*/2 * * * * /data/nodebb/nodebb.mongo.backup.sh &gt;&gt; /data/nodebb/backupLogs/backup.log.$(date &quot;+\%Y\%m\%d\%H\%M\%S&quot;) 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">cat nodebb.mongo.backup.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">backupDir=/data/nodebb/db-backups/mongo.backup.v$(date &quot;+%Y%m%d_%H%M%S&quot;)</span><br><span class="line">mkdir -v $&#123;backupDir&#125;</span><br><span class="line">/usr/bin/mongodump -h 127.0.0.1:27017 -d nodebb -o $&#123;backupDir&#125;</span><br><span class="line">cd $(dirname $&#123;backupDir&#125;)</span><br><span class="line">tar -czf  $(basename $&#123;backupDir&#125;).tar.gz $(basename $&#123;backupDir&#125;)</span><br><span class="line">rm -rvf $(basename $&#123;backupDir&#125;)</span><br></pre></td></tr></table></figure><h2 id="中文搜索支持"><a href="#中文搜索支持" class="headerlink" title="中文搜索支持"></a>中文搜索支持</h2><p>nodebb-plugin-solr</p><h2 id="solr部署"><a href="#solr部署" class="headerlink" title="solr部署"></a>solr部署</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget http://apache.mirrors.lucidnetworks.net/lucene/solr/8.2.0/solr-8.2.0.tgz -O - |tar -zx</span><br><span class="line">ulimit -u 65000</span><br><span class="line">cd /path/to/solr/server/solr</span><br><span class="line">./bin/solr start</span><br><span class="line">/path/to/solr/bin/solr create_core -c nodebb            #创建核心</span><br><span class="line">/path/to/solr/bin/solr delete -c nodebb                 # 删除核心创建核心</span><br><span class="line">/path/to/solr/bin/solr status                           # 查看solr节点信息</span><br><span class="line">/path/to/solr/bin/solr start -e cloud                   #以cloud实例模式运行</span><br><span class="line">/path/to/solr/bin/solr create_collection -c nodebb      #cloud模式下</span><br><span class="line">/path/to/solr/bin/solr create_collection -c nodebb -s 3 -rf 3</span><br><span class="line">/path/to/solr/bin/solr auth enable -type basicAuth -credentials admin:nodebbAdmin</span><br><span class="line">/path/to/solr/bin/solr auth disable</span><br></pre></td></tr></table></figure><ul><li><a href="https://www.w3cschool.cn/solr_doc/solr_doc-emn62fs5.html">以示例配置运行</a></li></ul><h1 id="discourse"><a href="#discourse" class="headerlink" title="discourse"></a>discourse</h1><p>官方仅提供docker部署方式</p><h1 id="Flarum"><a href="#Flarum" class="headerlink" title="Flarum"></a>Flarum</h1><p>Beta版本，功能和易用性相对较差</p><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><p><a href="https://docs.archive.nodebb.org/zh_CN/latest/configuring/databases/mongo.html">nodebb官方文档</a></p></li><li><p><a href="https://docs.nodebb.org/installing/os/centos/">https://docs.nodebb.org/installing/os/centos/</a></p></li><li><p><a href="https://hearrain.com/2015/12/847">https://hearrain.com/2015/12/847</a></p></li><li><p><a href="https://www.rosehosting.com/blog/how-to-install-nodebb-on-a-centos-7-vps/">https://www.rosehosting.com/blog/how-to-install-nodebb-on-a-centos-7-vps/</a></p></li></ul><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/mediawiki%E5%AF%BC%E8%88%AA%E8%8F%9C%E5%8D%95%E8%AE%BE%E7%BD%AE.html">MediaWiki导航菜单设置</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;摘要内容&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="开源技术栈" scheme="https://www.lengyuewusheng.com/categories/%E5%BC%80%E6%BA%90%E6%8A%80%E6%9C%AF%E6%A0%88/"/>
    
    
    <category term="开源工具" scheme="https://www.lengyuewusheng.com/tags/%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7/"/>
    
    <category term="nodebb" scheme="https://www.lengyuewusheng.com/tags/nodebb/"/>
    
  </entry>
  
  <entry>
    <title>基于scrcpy远程操控android设备</title>
    <link href="https://www.lengyuewusheng.com/%E5%9F%BA%E4%BA%8Escrcpy%E8%BF%9C%E7%A8%8B%E6%93%8D%E6%8E%A7android%E8%AE%BE%E5%A4%87.html"/>
    <id>https://www.lengyuewusheng.com/%E5%9F%BA%E4%BA%8Escrcpy%E8%BF%9C%E7%A8%8B%E6%93%8D%E6%8E%A7android%E8%AE%BE%E5%A4%87.html</id>
    <published>2019-05-11T05:17:27.000Z</published>
    <updated>2019-12-01T13:22:05.308Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>非常酷炫的操作。。。</p></blockquote><span id="more"></span><h1 id="USB模式"><a href="#USB模式" class="headerlink" title="USB模式"></a>USB模式</h1><blockquote><p>需要通过USB线直连Android设备。</p></blockquote><h2 id="打开开发者选项"><a href="#打开开发者选项" class="headerlink" title="打开开发者选项"></a>打开开发者选项</h2><blockquote><p>当手机开发者选项隐藏关闭时，需要打开开发者选项，设置&gt;系统&gt;关于手机&gt;版本号，<a href="https://developer.android.com/studio/debug/dev-options?hl=zh-CN">点击版本号信息7次</a>,返回上一屏幕，在底部附近可以找到开发者选项</p></blockquote><h2 id="打开USB调试"><a href="#打开USB调试" class="headerlink" title="打开USB调试"></a>打开USB调试</h2><blockquote><p>设置&gt;系统&gt;开发者选项&gt;USB调试，打开USB调试</p></blockquote><h2 id="打开”仅充电”模式下允许ADB调试"><a href="#打开”仅充电”模式下允许ADB调试" class="headerlink" title="打开”仅充电”模式下允许ADB调试"></a>打开”仅充电”模式下允许ADB调试</h2><blockquote><p>设置&gt;系统&gt;开发者选项&gt;”仅充电”模式下允许ADB调试，打开”仅充电”模式下允许ADB调试</p></blockquote><h2 id="执行-scrcpy-exe-即可"><a href="#执行-scrcpy-exe-即可" class="headerlink" title="执行 scrcpy.exe, 即可"></a>执行 <code>scrcpy.exe</code>, 即可</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\scrcpy-win64-v1.10&gt; .\scrcpy.exe</span><br><span class="line">INFO: scrcpy 1.10 &lt;https://github.com/Genymobile/scrcpy&gt;</span><br><span class="line">E:\PortableSoftwares\scrcpy-win64-v1.10\scrcpy-server.jar: 1 file pushed. 0.0 MB/s (22546 bytes in 0.435s)</span><br><span class="line">INFO: Initial texture: 1080x1920</span><br></pre></td></tr></table></figure><h1 id="wifi模式"><a href="#wifi模式" class="headerlink" title="wifi模式"></a>wifi模式</h1><blockquote><p>前三步和USB模式相同，同时要求，adb调试设备和被调试设备在同一WLAN网络</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS C:\WINDOWS\system32&gt; adb tcpip 5555</span><br><span class="line">PS C:\WINDOWS\system32&gt; adb connect 10.10.10.2:5555</span><br><span class="line">connected to 10.10.10.2:5555</span><br><span class="line"># 至此可拔掉USB连接线</span><br><span class="line">PS C:\WINDOWS\system32&gt; cd C:\scrcpy-win64-v1.10</span><br><span class="line">PS C:\scrcpy-win64-v1.10&gt; .\scrcpy.exe</span><br><span class="line">INFO: scrcpy 1.10 &lt;https://github.com/Genymobile/scrcpy&gt;</span><br><span class="line">E:\PortableSoftwares\scrcpy-win64-v1.10\scrcpy-server.jar: 1 file pushed. 0.0 MB/s (22546 bytes in 0.431s)</span><br><span class="line">INFO: Initial texture: 1080x1920</span><br></pre></td></tr></table></figure><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul><li><p><a href="https://github.com/Genymobile/scrcpy">scrcpy</a></p></li><li><p><a href="https://github.com/Tomotoes/scrcpy-gui">scrcpy-gui</a></p></li><li><p><a href="https://developer.android.com/studio/command-line/adb.html#Enabling">android开发者文档·在设备上启用 adb 调试</a></p></li><li><p><a href="https://developer.android.com/studio/releases/platform-tools.html">Android SDK Platform-Tools下载·adb命令</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;非常酷炫的操作。。。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="工具控" scheme="https://www.lengyuewusheng.com/categories/%E5%B7%A5%E5%85%B7%E6%8E%A7/"/>
    
    
    <category term="scrcpy" scheme="https://www.lengyuewusheng.com/tags/scrcpy/"/>
    
    <category term="Android" scheme="https://www.lengyuewusheng.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Linux开机启动的多种实现方式</title>
    <link href="https://www.lengyuewusheng.com/linux%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E7%9A%84%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F.html"/>
    <id>https://www.lengyuewusheng.com/linux%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E7%9A%84%E5%A4%9A%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F.html</id>
    <published>2019-04-23T04:14:58.000Z</published>
    <updated>2019-06-05T05:00:20.414Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>开机启动是运维自动化的重要组成部分。</p></blockquote><span id="more"></span><h1 id="x2F-etc-x2F-rc-local"><a href="#x2F-etc-x2F-rc-local" class="headerlink" title="&#x2F;etc&#x2F;rc.local"></a>&#x2F;etc&#x2F;rc.local</h1><blockquote><p>可将开机启动命令追加到&#x2F;etc&#x2F;rc.local中</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># readlink /etc/rc.local</span><br><span class="line">rc.d/rc.local         // /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><h1 id="chkconfig"><a href="#chkconfig" class="headerlink" title="chkconfig"></a>chkconfig</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># readlink /etc/init.d</span><br><span class="line">rc.d/init.d           // /etc/rc.d/init.d/</span><br><span class="line"></span><br><span class="line">chkconfig --add servicename             # 使服务会被在/etc/rc.d/rcN.d中赋予K/S入口</span><br><span class="line">chkconfig --level 35 servicename on 或 sudo update-rc.d servicename defaults 95</span><br><span class="line">chkconfig --list</span><br></pre></td></tr></table></figure><ul><li><p>服务脚本必须存放在&#x2F;etc&#x2F;ini.d&#x2F;目录下</p></li><li><p>&#x2F;etc&#x2F;ini.d&#x2F;下的脚本最开始必须包含以下三行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line"># chkconfig: - 58 74    # 分别代表运行级别，启动优先权，关闭优先权，此行代码必须</span><br><span class="line"># description:</span><br></pre></td></tr></table></figure></li></ul><h1 id="x2F-etc-x2F-profile-d-x2F"><a href="#x2F-etc-x2F-profile-d-x2F" class="headerlink" title="&#x2F;etc&#x2F;profile.d&#x2F;"></a>&#x2F;etc&#x2F;profile.d&#x2F;</h1><ul><li><p>登陆自动执行(&#x2F;etc&#x2F;profile.d&#x2F;)，不仅仅是开机自动执行。</p></li><li><p>必须是.sh后缀的脚本文件</p></li></ul><h1 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --type=service | grep enabled         # 查看允许开机启动的服务进程</span><br><span class="line">systemctl list -units --type=service                            # 查看所有已启动的服务</span><br><span class="line">systemctl mask daemon.service                                   # 在任何情况下系统启动时都不启动该进程</span><br><span class="line">systemctl enable daemon.service                                 # 设置开机启动</span><br><span class="line">systemctl disable daemon.service                                # 禁止开机启动</span><br><span class="line">systemctl is-enabled daemon.service                             # 确认服务是否开机启动</span><br><span class="line">ll  /etc/systemd/system/multi-user.target.wants/                # 查看所有开启启动的服务</span><br></pre></td></tr></table></figure><h1 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@reboot root ( sleep 30; sh /path/to/script.sh )    # 经验证，cron配置中支持小括号</span><br></pre></td></tr></table></figure><ul><li>cron支持的关键字<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@reboot at startup</span><br><span class="line">@yearly once a year</span><br><span class="line">@annually ( == @yearly)</span><br><span class="line">@monthly once a month</span><br><span class="line">@weekly once a week</span><br><span class="line">@daily once a day</span><br><span class="line">@midnight ( == @daily)</span><br><span class="line">@hourly once an hour</span><br></pre></td></tr></table></figure></li></ul><div><h1>推荐文章<span style="font-size:0.45em; color:gray">（由<a href="https://github.com/huiwang/hexo-recommended-posts">hexo文章推荐插件</a>驱动）</span></h1><ul><li><a href="https://www.lengyuewusheng.com/prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5.html">prometheus监控实践</a></li><li><a href="https://www.lengyuewusheng.com/linux%E5%86%85%E6%A0%B8%E5%B4%A9%E6%BA%83%E5%88%86%E6%9E%90.html">Linux内核崩溃分析</a></li><li><a href="https://blogs.kainy.cn/2010/06/网络操作系统（Linux）期末复习题/">网络操作系统（Linux）期末复习题</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;开机启动是运维自动化的重要组成部分。&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://www.lengyuewusheng.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://www.lengyuewusheng.com/tags/Linux/"/>
    
    <category term="chkconfig" scheme="https://www.lengyuewusheng.com/tags/chkconfig/"/>
    
    <category term="systemd" scheme="https://www.lengyuewusheng.com/tags/systemd/"/>
    
  </entry>
  
  <entry>
    <title>Linux环境中精确控制普通用户的sudo权限</title>
    <link href="https://www.lengyuewusheng.com/linux%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%B2%BE%E7%A1%AE%E6%8E%A7%E5%88%B6%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E7%9A%84sudo%E6%9D%83%E9%99%90.html"/>
    <id>https://www.lengyuewusheng.com/linux%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%B2%BE%E7%A1%AE%E6%8E%A7%E5%88%B6%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E7%9A%84sudo%E6%9D%83%E9%99%90.html</id>
    <published>2019-02-07T12:56:23.000Z</published>
    <updated>2019-06-05T05:01:37.092Z</updated>
    
    <content type="html"><![CDATA[<p>精准施控才能游刃有余。</p><span id="more"></span><h1 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h1><blockquote><p>在持续集成的实践中,为了保障生产环境安全可靠避免意外事故的发生。需要限制用户的操作权限，又要满足构建需要，因此需要对持续集成过程中的操作命令权限进行精准控制。实现最小权限开放，最大灵活性保障。</p></blockquote><h1 id="sudo配置"><a href="#sudo配置" class="headerlink" title="sudo配置"></a>sudo配置</h1><ul><li><p>配置文件名不能包含.后缀(文件名中不能包含.)，否则配置不生效。</p></li><li><p>生成配置</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sudoers.d/jenkins_deploy &lt;&lt; EOF</span><br><span class="line">Host_Alias     JENKINS_SERVERS = $(echo -n $(ip addr show dev eth0 | awk &#x27;/inet/ &#123;sub(/\//, &quot; &quot;); print $2&#125;&#x27;|head -1)), 127.0.0.1</span><br><span class="line">Cmnd_Alias      JENKINS_CMD = $(which rsync), $(which ln), $(which unlink), $(which readlink), $(which test), $(which mv), $(which mkdir)</span><br><span class="line">Defaults:jenkins        !requiretty</span><br><span class="line">Defaults!JENKINS_CMD  !syslog</span><br><span class="line">jenkins         JENKINS_SERVERS=(root)      NOPASSWD: JENKINS_CMD</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li><p>配置范例</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Host_Alias     JENKINS_SERVERS = 10.0.0.1, 127.0.0.1</span><br><span class="line">Cmnd_Alias      JENKINS_CMD = /usr/bin/rsync, /bin/ln, /bin/unlink, /usr/bin/readlink, /usr/bin/test, /bin/mv, /bin/mkdir</span><br><span class="line">Defaults:jenkins    !requiretty</span><br><span class="line">Defaults!JENKINS_CMD!syslog</span><br><span class="line">jenkinsJENKINS_SERVERS=(root)      NOPASSWD: JENKINS_CMD</span><br></pre></td></tr></table></figure></li></ul><blockquote><ul><li>主机别名定义 sudo 用户有权在哪个服务器（或特定范围内的服务器）上发出命令。在主机别名中，可以使用 DNS 名称或 IP 地址，或者指定整个网络范围（例如 172.17.12.0&#x2F;24）。要限制访问范围，应该仅指定群集节点的主机名。别名必须全部而且只能使用大写英文字母的组合</li><li>centos 5 的默认版本sudo-1.7.2p1-14.el5_8.4 不支持JENKINS_SERVERS中使用网段掩码</li></ul></blockquote><h1 id="ALL-ALL-x3D-ALL-ALL-配置字段解释"><a href="#ALL-ALL-x3D-ALL-ALL-配置字段解释" class="headerlink" title="ALL ALL&#x3D;(ALL) ALL 配置字段解释"></a>ALL ALL&#x3D;(ALL) ALL 配置字段解释</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ALL ALL=(ALL) ALL</span><br><span class="line">The first ALL is the users allowed</span><br><span class="line">The second one is the hosts</span><br><span class="line">The third one is the user as you are running the command</span><br><span class="line">The last one is the commands allowed</span><br></pre></td></tr></table></figure><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul><li><p><a href="https://unix.stackexchange.com/questions/201858/what-does-all-all-all-all-mean-in-sudoers">What does “ALL ALL&#x3D;(ALL) ALL” mean in sudoers?</a></p></li><li><p><a href="https://wiki.archlinux.org/index.php/Sudo">archlinux·sudo</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;精准施控才能游刃有余。&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://www.lengyuewusheng.com/categories/Linux/"/>
    
    
    <category term="linux" scheme="https://www.lengyuewusheng.com/tags/linux/"/>
    
    <category term="权限管理" scheme="https://www.lengyuewusheng.com/tags/%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"/>
    
    <category term="sudoers" scheme="https://www.lengyuewusheng.com/tags/sudoers/"/>
    
  </entry>
  
  <entry>
    <title>Apache No space left on device</title>
    <link href="https://www.lengyuewusheng.com/apache-no-space-left-on-device.html"/>
    <id>https://www.lengyuewusheng.com/apache-no-space-left-on-device.html</id>
    <published>2019-01-31T13:04:10.000Z</published>
    <updated>2019-04-09T06:13:04.382Z</updated>
    
    <content type="html"><![CDATA[<blockquote class="blockquote-center"><p>Inter-Process Communication，进程间通信</p></blockquote><span id="more"></span><h1 id="报错信息"><a href="#报错信息" class="headerlink" title="报错信息"></a>报错信息</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat /var/logs/httpd/error_log |grep -i device</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] suEXEC mechanism enabled (wrapper: /usr/sbin/suexec)</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] sohudb_post_config begin</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] create_server_temp_conf begin</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] create_server_temp_conf end</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] Digest: generating secret for digest authentication ...</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] Digest: done</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] sohudb_post_config begin</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] cp_create: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] qdb_cp_create: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] socket_cp_create: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] schat_cp_create: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] set_mc_host_sc end</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] cp_initialize: begin 23014</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] cp_initialize: for loop i=0, server_no:1</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] cp_initialize: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] set_qdb_host_sc end</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] qdb_cp_initialize: begin 23014</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] qdb_cp_initialize: for loop i=0, server_no:1</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] qdb_cp_initialize: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] set_socket_host_sc end</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] socket_cp_initialize: begin 23014</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] socket_cp_initialize: for loop i=0, server_no:1</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] socket_cp_initialize: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] set_schat_host_sc end</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] schat_cp_initialize: begin 23014</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] schat_cp_initialize: for loop i=0, server_no:1</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] schat_cp_initialize: for loop i=0, server_no:1,0,900,1000</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] schat_cp_initialize: ok</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [notice] sohudb_post_config end</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [warn] pid file /etc/httpd/run/httpd.pid overwritten -- Unclean shutdown of previous Apache run?</span><br><span class="line">[Wed Nov 21 20:15:01 2018] [emerg] (28)No space left on device: Couldn&#x27;t create accept lock (/etc/httpd/logs/accept.lock.23014) (5)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># ipcs -s</span><br><span class="line"></span><br><span class="line">------ Semaphore Arrays --------</span><br><span class="line">key        semid      owner      perms      nsems</span><br><span class="line">0x000000a7 0          root      600        1</span><br><span class="line">0x00000000 65273857   apache    600        1</span><br><span class="line">0x00000000 65372162   apache    600        1</span><br><span class="line">0x00000000 65470467   apache    600        1</span><br><span class="line">0x00000000 65568772   apache    600        1</span><br><span class="line">0x00000000 65667077   apache    600        1</span><br><span class="line">0x00000000 65765382   apache    600        1</span><br><span class="line">0x00000000 65863687   apache    600        1</span><br><span class="line">0x00000000 65961992   apache    600        1</span><br><span class="line">0x00000000 66060297   apache    600        1</span><br><span class="line">0x00000000 66158602   apache    600        1</span><br><span class="line">0x00000000 66256907   apache    600        1</span><br><span class="line">0x00000000 66355212   apache    600        1</span><br><span class="line">0x00000000 66453517   apache    600        1</span><br><span class="line">0x00000000 66551822   apache    600        1</span><br><span class="line">0x00000000 66650127   apache    600        1</span><br><span class="line">0x00000000 66748432   apache    600        1</span><br><span class="line">0x00000000 66846737   apache    600        1</span><br><span class="line">0x00000000 66945042   apache    600        1</span><br><span class="line">0x00000000 67043347   apache    600        1</span><br><span class="line">0x00000000 67141652   apache    600        1</span><br><span class="line">0x00000000 67239957   apache    600        1</span><br><span class="line">0x00000000 67338262   apache    600        1</span><br><span class="line">0x00000000 67436567   apache    600        1</span><br><span class="line">0x00000000 67534872   apache    600        1</span><br><span class="line">0x00000000 67633177   apache    600        1</span><br><span class="line">0x00000000 67731482   apache    600        1</span><br><span class="line">0x00000000 67829787   apache    600        1</span><br><span class="line">0x00000000 67928092   apache    600        1</span><br><span class="line">0x00000000 68026397   apache    600        1</span><br><span class="line">0x00000000 68124702   apache    600        1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># ipcs -l</span><br><span class="line"></span><br><span class="line">------ Shared Memory Limits --------</span><br><span class="line">max number of segments = 4096</span><br><span class="line">max seg size (kbytes) = 67108864</span><br><span class="line">max total shared memory (kbytes) = 17179869184</span><br><span class="line">min seg size (bytes) = 1</span><br><span class="line"></span><br><span class="line">------ Semaphore Limits --------</span><br><span class="line">max number of arrays = 512</span><br><span class="line">max semaphores per array = 25032000</span><br><span class="line">max semaphores system wide = 32</span><br><span class="line">max ops per semop call = 512</span><br><span class="line">semaphore max value = 32767</span><br><span class="line"></span><br><span class="line">------ Messages: Limits --------</span><br><span class="line">max queues system wide = 16</span><br><span class="line">max size of message (bytes) = 65536</span><br><span class="line">default max size of queue (bytes) = 65536</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># ipcs -a</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status</span><br><span class="line">0x74008327 3440640    root      600        4          0</span><br><span class="line">0x740082fd 4128769    root      600        4          0</span><br><span class="line">0x00000000 4489218    root      644        80         2</span><br><span class="line">0x740082fc 4096003    root      600        4          0</span><br><span class="line">0x00000000 4521988    root      644        16384      2</span><br><span class="line">0x00000000 4554757    root      644        280        2</span><br><span class="line"></span><br><span class="line">------ Semaphore Arrays --------</span><br><span class="line">key        semid      owner      perms      nsems</span><br><span class="line">0x000000a7 0          root      600        1</span><br><span class="line">0x00000000 170524673  apache    600        1</span><br><span class="line">0x00000000 170557442  apache    600        1</span><br><span class="line"></span><br><span class="line">------ Message Queues --------</span><br><span class="line">key        msqid      owner      perms      used-bytes   messages</span><br></pre></td></tr></table></figure><h1 id="处理方案"><a href="#处理方案" class="headerlink" title="处理方案"></a>处理方案</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># for i in $(/usr/bin/ipcs -s | awk &#x27;/apache/ &#123;print $2&#125;&#x27;); do /usr/bin/ipcrm -s $i; done</span><br><span class="line"># ipcs -s</span><br><span class="line"></span><br><span class="line">------ Semaphore Arrays --------</span><br><span class="line">key        semid      owner      perms      nsems</span><br><span class="line">0x000000a7 0          root      600        1</span><br><span class="line">0x00000000 170524673  apache    600        1</span><br><span class="line">0x00000000 170557442  apache    600        1</span><br></pre></td></tr></table></figure><h1 id="linux-x2F-unix下的进程间两类通信方式"><a href="#linux-x2F-unix下的进程间两类通信方式" class="headerlink" title="linux&#x2F;unix下的进程间两类通信方式"></a>linux&#x2F;unix下的进程间两类通信方式</h1><h2 id="基于文件的IPC"><a href="#基于文件的IPC" class="headerlink" title="基于文件的IPC"></a>基于文件的IPC</h2><ul><li>基于普通文件的IPC</li><li>基于管道文件的IPC<ul><li>普通管道</li><li>匿名管道<ul><li>匿名管道只能使用在父子进程之间</li></ul></li></ul></li><li>基于socket文件的IPC<ul><li>对等模型<ul><li>对等模型主要用于udp编程</li></ul></li><li>C&#x2F;S模型<ul><li>C&#x2F;S模型主要用于TCP编程</li></ul></li></ul></li></ul><h2 id="基于内存的IPC"><a href="#基于内存的IPC" class="headerlink" title="基于内存的IPC"></a>基于内存的IPC</h2><ul><li>基于共享内存的IPC，</li><li>基于共享队列的IPC，</li><li>基于信号量的IPC。</li><li>内核内存的工具（ipcs）<blockquote><p>ipcs命令往标准输出写入一些关于活动进程间通信设施的信息.</p><ul><li>ipcs可以指定查看的具体信息，<ul><li>如ipcs -m 查看共享内存，</li><li>-q：查看共享队列，</li><li>ipcs -s查看共享信号量，</li><li>以上3中都不指定时则是查看共享内存、共享队列和共享信号量</li></ul></li></ul></blockquote></li></ul><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><p><a href="https://major.io/2007/08/24/apache-no-space-left-on-device-couldnt-create-accept-lock/">Apache: No space left on device: Couldn’t create accept lock</a></p></li><li><p><a href="http://www.voidcn.com/article/p-xilljgvz-ms.html">ipcs命令详解</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote class=&quot;blockquote-center&quot;&gt;
&lt;p&gt;Inter-Process Communication，进程间通信&lt;/p&gt;

&lt;/blockquote&gt;</summary>
    
    
    
    <category term="IPC" scheme="https://www.lengyuewusheng.com/categories/IPC/"/>
    
    
    <category term="Apache" scheme="https://www.lengyuewusheng.com/tags/Apache/"/>
    
    <category term="httpd" scheme="https://www.lengyuewusheng.com/tags/httpd/"/>
    
    <category term="IPC" scheme="https://www.lengyuewusheng.com/tags/IPC/"/>
    
  </entry>
  
  <entry>
    <title>应用开发的12要素</title>
    <link href="https://www.lengyuewusheng.com/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E7%9A%8412%E8%A6%81%E7%B4%A0.html"/>
    <id>https://www.lengyuewusheng.com/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E7%9A%8412%E8%A6%81%E7%B4%A0.html</id>
    <published>2019-01-25T14:47:57.000Z</published>
    <updated>2019-04-09T06:16:26.262Z</updated>
    
    <content type="html"><![CDATA[<p>12-Factor 为构建 SaaS 应用提供方法论。</p><span id="more"></span><ul><li><p>基准代码</p><blockquote><p>一份基准代码，多份部署</p></blockquote></li><li><p>依赖</p><blockquote><p>显式声明依赖关系</p></blockquote></li><li><p>配置</p><blockquote><p>在环境中存储配置</p></blockquote></li><li><p>后端服务</p><blockquote><p>把后端服务当作附加资源</p></blockquote></li><li><p>构建，发布，运行</p><blockquote><p>严格分离构建和运行</p></blockquote></li><li><p>进程</p><blockquote><p>以一个或多个无状态进程运行应用</p></blockquote></li><li><p>端口绑定</p><blockquote><p>通过端口绑定提供服务</p></blockquote></li><li><p>并发</p><blockquote><p>通过进程模型进行扩展</p></blockquote></li><li><p>易处理</p><blockquote><p>快速启动和优雅终止可最大化健壮性</p></blockquote></li><li><p>开发环境与线上环境等价</p><blockquote><p>尽可能的保持开发，预发布，线上环境相同</p></blockquote></li><li><p>日志</p><blockquote><p>把日志当作事件流</p></blockquote></li><li><p>管理进程</p><blockquote><p>后台管理任务当作一次性进程运行</p></blockquote></li></ul><h1 id="转载自"><a href="#转载自" class="headerlink" title="转载自"></a>转载自</h1><ul><li><a href="https://www.12factor.net/zh_cn/">THE TWELVE-FACTOR APP</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;12-Factor 为构建 SaaS 应用提供方法论。&lt;/p&gt;</summary>
    
    
    
    <category term="12factor" scheme="https://www.lengyuewusheng.com/categories/12factor/"/>
    
    
    <category term="12factor" scheme="https://www.lengyuewusheng.com/tags/12factor/"/>
    
  </entry>
  
</feed>
